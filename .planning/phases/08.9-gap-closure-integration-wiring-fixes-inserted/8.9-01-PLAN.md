---
id: 8.9-01
wave: 1
depends_on: []
files_modified:
  - src/mcp_server/tools.py
  - src/mcp_server/server.py
autonomous: true
requirements:
  - R6.1
---

# Plan 8.9-01: Add graphiti_index MCP Tool

## Objective

Add the missing `graphiti_index` tool handler to `src/mcp_server/tools.py` and register it in `src/mcp_server/server.py`. MCP users currently cannot trigger git history indexing from Claude Code because the tool does not exist.

## Context

@src/mcp_server/tools.py
@src/mcp_server/server.py
@.planning/phases/08.9-gap-closure-integration-wiring-fixes-inserted/08.9-RESEARCH.md

## Background

The `graphiti index` CLI command exists at `src/cli/commands/index.py` with flags:
- `--full` (bool) — wipe and re-index from scratch
- `--since <str>` — index commits since date (YYYY-MM-DD) or SHA
- `--verbose` — show per-commit progress (DO NOT expose in MCP — callers don't see stdout progress)

All existing MCP tools follow the same pattern:
1. Plain Python function using `_run_graphiti(args, timeout, cwd=_get_cwd())`
2. Returns `stdout.strip()` or raises `RuntimeError` on non-zero exit
3. Added to `__all__` list
4. Imported in server.py and registered with `mcp.tool()(fn)`

The tool comment in server.py currently says "Register all 10 CLI tools" — update to "11".

## Tasks

<task id="1" type="auto">
  <title>Add graphiti_index function to tools.py</title>
  <files>
    - src/mcp_server/tools.py
  </files>
  <action>
    In `src/mcp_server/tools.py`, add the `graphiti_index` function between `graphiti_compact` and `graphiti_capture` (in the write/action tools section). Then add it to `__all__`.

    The function signature and implementation:

    ```python
    def graphiti_index(
        full: bool = False,
        since: str = "",
    ) -> str:
        """Index git history into the knowledge graph.

        Incremental by default — only processes commits not yet indexed.
        Use full=True to wipe all git-indexed knowledge and re-index entire
        history from scratch. This operation can be slow for large repositories
        (5+ minutes for histories with thousands of commits).

        Args:
            full: If True, wipe all git-indexed knowledge and re-index from scratch.
            since: Index commits since date (YYYY-MM-DD) or commit SHA (optional).
                   Empty string means no filtering (default — all new commits).

        Returns:
            Status message from the CLI with commits processed and entities created.

        Raises:
            RuntimeError: If the graphiti CLI returns a non-zero exit code.
        """
        cmd = ["index"]
        if full:
            cmd.append("--full")
        if since:
            cmd.extend(["--since", since])

        returncode, stdout, stderr = _run_graphiti(cmd, timeout=300, cwd=_get_cwd())

        if returncode != 0:
            raise RuntimeError(f"graphiti index failed: {stderr.strip()}")

        return stdout.strip() or "Git history indexed successfully."
    ```

    Then update `__all__` to include `"graphiti_index"`. Place it after `"graphiti_compact"` to maintain logical grouping (write/action tools):

    ```python
    __all__ = [
        "graphiti_add",
        "graphiti_search",
        "graphiti_list",
        "graphiti_show",
        "graphiti_delete",
        "graphiti_summarize",
        "graphiti_compact",
        "graphiti_index",
        "graphiti_capture",
        "graphiti_health",
        "graphiti_config",
    ]
    ```

    IMPORTANT: Use standard `logging` (not structlog) — this is an MCP server module. Never print to stdout.
  </action>
  <verify>
    <automated>cd /home/tasostilsi/Development/Projects/graphiti-knowledge-graph && python -c "from src.mcp_server.tools import graphiti_index; print('graphiti_index imported OK')"</automated>
  </verify>
  <done>
    - `graphiti_index` function exists in tools.py with full, since parameters
    - Function uses `_run_graphiti(["index", ...], timeout=300, cwd=_get_cwd())`
    - `"graphiti_index"` is in `__all__`
    - No structlog or print statements
  </done>
</task>

<task id="2" type="auto">
  <title>Register graphiti_index in server.py</title>
  <files>
    - src/mcp_server/server.py
  </files>
  <action>
    In `src/mcp_server/server.py`:

    1. Add `graphiti_index` to the import block from `src.mcp_server.tools`. Place it after `graphiti_compact` in the import list to maintain ordering consistency.

    Before:
    ```python
    from src.mcp_server.tools import (
        graphiti_add,
        graphiti_search,
        graphiti_list,
        graphiti_show,
        graphiti_delete,
        graphiti_summarize,
        graphiti_compact,
        graphiti_capture,
        graphiti_health,
        graphiti_config,
    )
    ```

    After:
    ```python
    from src.mcp_server.tools import (
        graphiti_add,
        graphiti_search,
        graphiti_list,
        graphiti_show,
        graphiti_delete,
        graphiti_summarize,
        graphiti_compact,
        graphiti_index,
        graphiti_capture,
        graphiti_health,
        graphiti_config,
    )
    ```

    2. Add `mcp.tool()(graphiti_index)` after `mcp.tool()(graphiti_compact)` in the registration block.

    Before:
    ```python
    # Register all 10 CLI tools with graphiti_ prefix
    mcp.tool()(graphiti_add)
    mcp.tool()(graphiti_search)
    mcp.tool()(graphiti_list)
    mcp.tool()(graphiti_show)
    mcp.tool()(graphiti_delete)
    mcp.tool()(graphiti_summarize)
    mcp.tool()(graphiti_compact)
    mcp.tool()(graphiti_capture)
    mcp.tool()(graphiti_health)
    mcp.tool()(graphiti_config)
    ```

    After:
    ```python
    # Register all 11 CLI tools with graphiti_ prefix
    mcp.tool()(graphiti_add)
    mcp.tool()(graphiti_search)
    mcp.tool()(graphiti_list)
    mcp.tool()(graphiti_show)
    mcp.tool()(graphiti_delete)
    mcp.tool()(graphiti_summarize)
    mcp.tool()(graphiti_compact)
    mcp.tool()(graphiti_index)
    mcp.tool()(graphiti_capture)
    mcp.tool()(graphiti_health)
    mcp.tool()(graphiti_config)
    ```
  </action>
  <verify>
    <automated>cd /home/tasostilsi/Development/Projects/graphiti-knowledge-graph && python -c "
from unittest.mock import patch
import sys

# Prevent actual MCP server startup
with patch('mcp.server.fastmcp.FastMCP.run'):
    import src.mcp_server.server as srv
    # Verify graphiti_index is registered
    tool_names = [t.name for t in srv.mcp._tools.values()] if hasattr(srv.mcp, '_tools') else []
    # Alternative: just verify import and registration lines
    import inspect
    src = inspect.getsource(srv)
    assert 'graphiti_index' in src, 'graphiti_index not in server.py'
    print('graphiti_index registered in server.py OK')
"</automated>
  </verify>
  <done>
    - `graphiti_index` imported from `src.mcp_server.tools` in server.py
    - `mcp.tool()(graphiti_index)` call present in server.py
    - Comment updated to "11 CLI tools"
  </done>
</task>

## Verification Criteria

```
python -c "from src.mcp_server.tools import graphiti_index; import inspect; src = inspect.getsource(graphiti_index); assert '--full' in src or 'full' in src; print('OK')"
```

## Must-Haves

- `graphiti_index` function exists in `src/mcp_server/tools.py` — satisfies R6.1 (MCP tools wrapping CLI operations)
- `graphiti_index` is registered in `server.py` with `mcp.tool()(graphiti_index)`
- No structlog or print() calls in the new tool function (MCP stdio integrity)
- `"graphiti_index"` present in `__all__`
