---
phase: 02-security-filtering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/models/security.py
  - src/config/security.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "Security data types exist for detection results"
    - "Configuration for entropy thresholds and exclusion patterns is centralized"
    - "Dependencies (detect-secrets, structlog) are installed"
  artifacts:
    - path: "src/models/security.py"
      provides: "SecretFinding dataclass, DetectionType enum, SanitizationResult"
      min_lines: 40
    - path: "src/config/security.py"
      provides: "Security configuration constants and defaults"
      contains: "DEFAULT_EXCLUSIONS"
    - path: "pyproject.toml"
      provides: "New dependencies"
      contains: "detect-secrets"
  key_links:
    - from: "src/config/security.py"
      to: "src/models/security.py"
      via: "imports DetectionType for config defaults"
      pattern: "from src.models.security import"
---

<objective>
Create security filtering foundation with data models, configuration, and dependencies.

Purpose: Establish the type system and configuration that all other security components will use. This is the foundation for the entire security filtering phase.

Output: Security models (SecretFinding, SanitizationResult), configuration (thresholds, exclusion patterns), and installed dependencies.
</objective>

<execution_context>
@/home/tasostilsi/.claude/get-shit-done/workflows/execute-plan.md
@/home/tasostilsi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-security-filtering/02-CONTEXT.md
@.planning/phases/02-security-filtering/02-RESEARCH.md
@src/models/__init__.py
@src/config/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create security models</name>
  <files>src/models/security.py, src/models/__init__.py</files>
  <action>
Create src/models/security.py with:

1. DetectionType enum with values:
   - AWS_KEY, GITHUB_TOKEN, JWT, GENERIC_API_KEY, PRIVATE_KEY, CONNECTION_STRING
   - HIGH_ENTROPY_BASE64, HIGH_ENTROPY_HEX
   - ALLOWLISTED (for tracking overrides)

2. SecretFinding dataclass:
   - detection_type: DetectionType
   - matched_text: str
   - line_number: int
   - confidence: Literal["high", "medium", "low"]
   - entropy_score: Optional[float] = None
   - file_path: Optional[str] = None

3. SanitizationResult dataclass:
   - original_content: str
   - sanitized_content: str
   - findings: list[SecretFinding]
   - allowlisted_count: int = 0
   - was_modified: bool (computed from findings)

4. FileExclusionResult dataclass:
   - file_path: Path
   - is_excluded: bool
   - matched_pattern: Optional[str] = None

Update src/models/__init__.py to export all new types.

Use dataclasses with frozen=True for immutability. Include proper __all__ exports.
  </action>
  <verify>
python -c "from src.models.security import DetectionType, SecretFinding, SanitizationResult, FileExclusionResult; print('Models OK')"
  </verify>
  <done>
All security model types importable and working. DetectionType has 9+ variants, SecretFinding has all required fields, SanitizationResult has was_modified computed property.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create security config and install dependencies</name>
  <files>src/config/security.py, src/config/__init__.py, pyproject.toml</files>
  <action>
1. Update pyproject.toml to add dependencies:
   - detect-secrets>=1.5.0 (secret detection)
   - structlog>=25.5.0 (structured audit logging)

2. Create src/config/security.py with:

```python
# Entropy thresholds (aggressive per user decision)
BASE64_ENTROPY_LIMIT = 3.5  # Default is 4.5, aggressive is 3.5
HEX_ENTROPY_LIMIT = 2.5     # Default is 3.0, aggressive is 2.5

# File size limit (skip large files)
MAX_FILE_SIZE_BYTES = 1_000_000  # 1MB

# Default file exclusion patterns
DEFAULT_FILE_EXCLUSIONS = [
    # Environment and secrets
    ".env", ".env.*", "*.env",
    "*secret*", "*credential*", "*password*",
    "*.key", "*.pem", "*.p12", "*.pfx", "*.jks",
    "*token*",

    # Directories (note trailing /)
    "node_modules/", ".git/", "venv/", ".venv/",
    "__pycache__/", ".pytest_cache/",

    # Test files (don't scan test fixtures)
    "tests/", "test/", "**/test_*.py", "**/*_test.py",
    "fixtures/", "mocks/",

    # Build artifacts
    "dist/", "build/", "*.egg-info/",
]

# Placeholder template
REDACTION_PLACEHOLDER = "[REDACTED:{type}]"

# Audit log settings
AUDIT_LOG_FILENAME = "audit.log"
AUDIT_LOG_MAX_BYTES = 10_000_000  # 10 MB
AUDIT_LOG_BACKUP_COUNT = 5

# detect-secrets plugin configuration
DETECT_SECRETS_PLUGINS = {
    "Base64HighEntropyString": {"base64_limit": BASE64_ENTROPY_LIMIT},
    "HexHighEntropyString": {"hex_limit": HEX_ENTROPY_LIMIT},
    "KeywordDetector": {},
    "AWSKeyDetector": {},
    "GitHubTokenDetector": {},
    "JwtTokenDetector": {},
    "PrivateKeyDetector": {},
    "BasicAuthDetector": {},
}
```

3. Update src/config/__init__.py to export security config.

4. Run: pip install -e . to install new dependencies.
  </action>
  <verify>
python -c "from src.config.security import DEFAULT_FILE_EXCLUSIONS, BASE64_ENTROPY_LIMIT; import detect_secrets; import structlog; print(f'Config OK, entropy={BASE64_ENTROPY_LIMIT}')"
  </verify>
  <done>
detect-secrets and structlog installed. Security config accessible with aggressive entropy thresholds (3.5 base64, 2.5 hex) and comprehensive exclusion patterns.
  </done>
</task>

</tasks>

<verification>
- [ ] `pip list | grep detect-secrets` shows 1.5.0+
- [ ] `pip list | grep structlog` shows 25.5.0+
- [ ] All models importable from src.models.security
- [ ] All config importable from src.config.security
- [ ] Entropy limits are aggressive (3.5, 2.5)
</verification>

<success_criteria>
Foundation complete when:
1. Security models (SecretFinding, SanitizationResult, DetectionType) exist and are importable
2. Security config (thresholds, exclusions, placeholders) exists and is importable
3. detect-secrets and structlog are installed
4. Entropy thresholds are aggressive per user decision (3.5 base64, 2.5 hex)
</success_criteria>

<output>
After completion, create `.planning/phases/02-security-filtering/02-01-SUMMARY.md`
</output>
