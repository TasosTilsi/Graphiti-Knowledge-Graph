---
plan: 8.7-01
phase: 8.7-gap-closure-hook-security-gaps-inserted
title: Fix scan_staged_secrets inverted deleted_file check
status: pending
created: 2026-02-27
---

# Plan 8.7-01: Fix scan_staged_secrets Inverted deleted_file Check

## Objective

Fix `scan_staged_secrets()` in `src/gitops/hooks.py` so it scans **newly staged files** (brand-new files not yet in HEAD), not just modified ones. Currently the function silently skips new files due to inverted GitPython semantics.

## Root Cause

`repo.index.diff("HEAD")` computes the diff from index (a) to HEAD (b).
For a **newly staged file** (in index, not in HEAD):
- `deleted_file=True` — file "disappears" going from index→HEAD
- `a_blob` has the content
- `b_blob=None`

For a **file staged for deletion** (in HEAD, removed from index):
- `new_file=True` — file "appears" going from index→HEAD
- `a_blob=None`
- `b_blob` has the old content

The existing code does `if diff_item.deleted_file: continue` — this **skips new files** (which it should scan) and passes through deleted files (which should be skipped).

## Fix

`src/gitops/hooks.py:62` — change the guard condition:

```python
# BEFORE (wrong): skips newly staged files
if diff_item.deleted_file:
    continue

# AFTER (correct): skip files staged for deletion (removed from index, a_blob=None)
if diff_item.new_file:
    continue
```

The existing `FileNotFoundError` catch at line 78 already handles the edge case where
a deletion diff item slips through (the file won't exist on disk).

## Files to Change

| File | Line | Change |
|------|------|--------|
| `src/gitops/hooks.py` | 62 | `deleted_file` → `new_file` in skip guard |

## Tasks

1. Read `src/gitops/hooks.py` lines 30–90 (confirm exact line numbers)
2. Apply one-line fix: change `if diff_item.deleted_file` to `if diff_item.new_file`
3. Update the comment from "Skip deleted files" to "Skip files staged for deletion (a_blob=None)"
4. Run pytest to confirm no regressions: `pytest tests/ -x -q`

## Verification

Run:
```bash
python3 -c "
import sys, tempfile
from pathlib import Path
sys.path.insert(0, '.')

with tempfile.TemporaryDirectory() as tmpdir:
    tmp_root = Path(tmpdir)
    import subprocess
    subprocess.run(['git', 'init'], cwd=tmp_root, capture_output=True)
    subprocess.run(['git', 'config', 'user.email', 'test@test.com'], cwd=tmp_root, capture_output=True)
    subprocess.run(['git', 'config', 'user.name', 'Test'], cwd=tmp_root, capture_output=True)
    # Stage a brand-new file with a fake AWS key (no initial commit needed)
    (tmp_root / 'secrets.py').write_text(\"KEY = 'AKIAIOSFODNN7EXAMPLE'\n\")
    subprocess.run(['git', 'add', 'secrets.py'], cwd=tmp_root, capture_output=True)
    from src.gitops.hooks import scan_staged_secrets
    warnings = scan_staged_secrets(tmp_root)
    assert warnings, f'Expected warnings for new file, got: {warnings}'
    print('PASS: new staged file detected')
"
```

Expected: `PASS: new staged file detected`

## Commit Message

```
fix(hooks): scan_staged_secrets now catches secrets in new staged files

repo.index.diff("HEAD") marks new files (in index, not in HEAD) as
deleted_file=True and staged deletions as new_file=True — inverted from
intuition. Fix: skip when new_file=True (a_blob=None) not deleted_file=True.
```
