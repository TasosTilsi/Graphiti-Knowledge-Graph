---
phase: 01-storage-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/storage/__init__.py
  - src/storage/selector.py
  - src/storage/graph_manager.py
autonomous: true

must_haves:
  truths:
    - "GraphSelector finds project root by detecting .git directory"
    - "GraphSelector returns None when not in a git repository"
    - "GraphManager creates KuzuDriver for global scope at correct path"
    - "GraphManager creates KuzuDriver for project scope at correct path"
    - "GraphManager maintains singleton instances per scope"
  artifacts:
    - path: "src/storage/selector.py"
      provides: "Project root detection and scope routing"
      contains: "class GraphSelector"
      exports: ["GraphSelector"]
    - path: "src/storage/graph_manager.py"
      provides: "Dual-scope Kuzu database manager"
      contains: "class GraphManager"
      exports: ["GraphManager"]
  key_links:
    - from: "src/storage/selector.py"
      to: "pathlib.Path"
      via: "directory traversal for .git detection"
      pattern: "\\(parent / \"\\.git\"\\)\\.exists\\(\\)"
    - from: "src/storage/graph_manager.py"
      to: "graphiti_core.driver.kuzu_driver.KuzuDriver"
      via: "database driver instantiation"
      pattern: "KuzuDriver\\(db="
    - from: "src/storage/graph_manager.py"
      to: "src/config/paths"
      via: "path constants import"
      pattern: "from src\\.config"
---

<objective>
Implement the core storage layer with GraphSelector for scope routing and GraphManager for dual-scope Kuzu database management.

Purpose: Provide the routing logic to determine which graph (global vs project) to use, and the manager that handles database lifecycle.
Output: Working GraphSelector that detects project roots, and GraphManager that creates/manages KuzuDriver instances for both scopes.
</objective>

<execution_context>
@/home/tasostilsi/.claude/get-shit-done/workflows/execute-plan.md
@/home/tasostilsi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-storage-foundation/01-RESEARCH.md
@.planning/phases/01-storage-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement GraphSelector for scope routing</name>
  <files>
    src/storage/__init__.py
    src/storage/selector.py
  </files>
  <action>
Create src/storage/__init__.py (empty for now, will add exports later).

Create src/storage/selector.py implementing:
```python
from pathlib import Path
from typing import Optional, Tuple
from src.models import GraphScope


class GraphSelector:
    """Selects appropriate graph scope based on context.

    Determines whether to use global or project scope by detecting
    if the current working directory is within a git repository.
    """

    @staticmethod
    def find_project_root(start_path: Optional[Path] = None) -> Optional[Path]:
        """Find project root by looking for .git directory.

        Args:
            start_path: Starting directory (defaults to current working directory)

        Returns:
            Path to project root if found, None if not in a git repository
        """
        current = start_path or Path.cwd()

        # Walk up directory tree looking for .git
        for parent in [current, *current.parents]:
            git_dir = parent / ".git"
            if git_dir.exists() and git_dir.is_dir():
                return parent

        return None

    @staticmethod
    def determine_scope(
        operation_type: str = "knowledge",
        prefer_project: bool = True,
        start_path: Optional[Path] = None
    ) -> Tuple[GraphScope, Optional[Path]]:
        """Determine which graph scope to use.

        Args:
            operation_type: Type of operation ('preference' always uses global,
                           other types use project if available)
            prefer_project: Whether to prefer project scope when available
            start_path: Starting path for project detection (defaults to cwd)

        Returns:
            Tuple of (scope, project_root_path). project_root_path is None for global scope.
        """
        # Preferences always use global scope
        if operation_type == "preference":
            return (GraphScope.GLOBAL, None)

        # Check if we're in a project
        project_root = GraphSelector.find_project_root(start_path)

        if project_root and prefer_project:
            return (GraphScope.PROJECT, project_root)
        else:
            return (GraphScope.GLOBAL, None)
```

Key implementation details:
- Uses pathlib for cross-platform compatibility
- Checks for .git as directory (not file, to handle main repos correctly)
- operation_type="preference" always routes to global (user preferences are global)
- Returns tuple allowing caller to know both scope and project path
  </action>
  <verify>
Create a temporary test directory with .git folder and verify:
```bash
mkdir -p /tmp/test-project/.git
cd /tmp/test-project
python -c "
from src.storage.selector import GraphSelector
from src.models import GraphScope

# Test project detection
root = GraphSelector.find_project_root()
assert root is not None, 'Should find project root'
print(f'Project root: {root}')

# Test scope determination
scope, path = GraphSelector.determine_scope()
assert scope == GraphScope.PROJECT, 'Should return PROJECT scope'
assert path is not None, 'Should return project path'
print(f'Scope: {scope}, Path: {path}')

# Test preference always global
scope, path = GraphSelector.determine_scope(operation_type='preference')
assert scope == GraphScope.GLOBAL, 'Preferences should use GLOBAL'
assert path is None, 'Global scope has no project path'
print('Preference scope: GLOBAL (correct)')

print('All selector tests passed!')
"
```

Also test from non-git directory:
```bash
cd /tmp
python -c "
from src.storage.selector import GraphSelector
from src.models import GraphScope

root = GraphSelector.find_project_root()
assert root is None, 'Should not find project root in /tmp'
print('No project root found (correct)')

scope, path = GraphSelector.determine_scope()
assert scope == GraphScope.GLOBAL, 'Should fall back to GLOBAL'
print('Falls back to GLOBAL scope (correct)')

print('Non-project tests passed!')
"
```
  </verify>
  <done>
GraphSelector correctly identifies project roots via .git detection, returns None outside git repos, and routes preferences to global scope while routing other operations to project scope when available.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement GraphManager for dual-scope database management</name>
  <files>
    src/storage/graph_manager.py
  </files>
  <action>
Create src/storage/graph_manager.py implementing:
```python
from pathlib import Path
from typing import Optional
from graphiti_core.driver.kuzu_driver import KuzuDriver
from src.models import GraphScope
from src.config import GLOBAL_DB_PATH, get_project_db_path


class GraphManager:
    """Manages dual-scope Kuzu database instances.

    Maintains singleton KuzuDriver instances for global and project scopes.
    Handles lazy initialization and proper cleanup.

    CRITICAL: Only one Database object should exist per database path.
    This class enforces that constraint via singleton pattern per scope.
    """

    def __init__(self):
        self._global_driver: Optional[KuzuDriver] = None
        self._project_driver: Optional[KuzuDriver] = None
        self._current_project_root: Optional[Path] = None

    def get_driver(
        self,
        scope: GraphScope,
        project_root: Optional[Path] = None
    ) -> KuzuDriver:
        """Get or create KuzuDriver for the specified scope.

        Args:
            scope: Which graph scope to access
            project_root: Required for PROJECT scope, ignored for GLOBAL

        Returns:
            KuzuDriver instance for the requested scope

        Raises:
            ValueError: If project_root not provided for PROJECT scope
        """
        if scope == GraphScope.GLOBAL:
            return self._get_global_driver()
        else:
            return self._get_project_driver(project_root)

    def _get_global_driver(self) -> KuzuDriver:
        """Get or create the global scope driver."""
        if self._global_driver is None:
            # Ensure directory exists
            GLOBAL_DB_PATH.parent.mkdir(parents=True, exist_ok=True)
            self._global_driver = KuzuDriver(db=str(GLOBAL_DB_PATH))
        return self._global_driver

    def _get_project_driver(self, project_root: Optional[Path]) -> KuzuDriver:
        """Get or create project scope driver.

        Handles project switching: if project_root differs from cached,
        closes old connection and creates new one.
        """
        if project_root is None:
            raise ValueError("project_root is required for PROJECT scope")

        # Check if we need to switch projects
        if self._project_driver is not None and self._current_project_root != project_root:
            # Project changed, close old connection
            self._project_driver.close()
            self._project_driver = None

        if self._project_driver is None:
            db_path = get_project_db_path(project_root)
            # Ensure directory exists
            db_path.parent.mkdir(parents=True, exist_ok=True)
            self._project_driver = KuzuDriver(db=str(db_path))
            self._current_project_root = project_root

        return self._project_driver

    def reset_project(self) -> None:
        """Reset project scope connection.

        Call this when context changes (e.g., user changed directories).
        Next get_driver() for PROJECT scope will detect new project.
        """
        if self._project_driver is not None:
            self._project_driver.close()
            self._project_driver = None
            self._current_project_root = None

    def close_all(self) -> None:
        """Close all database connections.

        Call this on application shutdown for clean resource release.
        """
        if self._global_driver is not None:
            self._global_driver.close()
            self._global_driver = None

        if self._project_driver is not None:
            self._project_driver.close()
            self._project_driver = None
            self._current_project_root = None
```

Key implementation details per RESEARCH.md:
- Singleton pattern per scope (avoids multiple Database objects to same path)
- Lazy initialization (driver created on first access)
- Project switching support (detects when project_root changes)
- Explicit close methods for clean shutdown
- Creates directories if they don't exist (mkdir parents=True)
- Passes string path to KuzuDriver (as required by its API)
  </action>
  <verify>
Test GraphManager initialization and driver creation:
```bash
python -c "
from pathlib import Path
from src.storage.graph_manager import GraphManager
from src.models import GraphScope
from src.config import GLOBAL_DB_PATH

manager = GraphManager()

# Test global driver creation
print('Testing global driver...')
global_driver = manager.get_driver(GraphScope.GLOBAL)
print(f'Global driver type: {type(global_driver).__name__}')
assert global_driver is not None, 'Global driver should be created'

# Verify singleton behavior
global_driver2 = manager.get_driver(GraphScope.GLOBAL)
assert global_driver is global_driver2, 'Should return same instance'
print('Singleton behavior verified')

# Test that global DB directory was created
assert GLOBAL_DB_PATH.parent.exists(), 'Global DB directory should exist'
print(f'Global DB directory exists: {GLOBAL_DB_PATH.parent}')

# Clean up
manager.close_all()
print('All GraphManager tests passed!')
"
```

Test project driver (requires temp project):
```bash
python -c "
from pathlib import Path
from src.storage.graph_manager import GraphManager
from src.models import GraphScope

# Create temp project
import tempfile
import os
temp_dir = tempfile.mkdtemp()
project_root = Path(temp_dir)
os.makedirs(project_root / '.git')

manager = GraphManager()

# Test project driver creation
print(f'Testing project driver for: {project_root}')
project_driver = manager.get_driver(GraphScope.PROJECT, project_root)
print(f'Project driver type: {type(project_driver).__name__}')
assert project_driver is not None, 'Project driver should be created'

# Verify project DB directory was created
expected_db_dir = project_root / '.graphiti'
assert expected_db_dir.exists(), 'Project DB directory should exist'
print(f'Project DB directory exists: {expected_db_dir}')

# Test error when project_root missing
try:
    manager.get_driver(GraphScope.PROJECT, None)
    assert False, 'Should raise ValueError'
except ValueError as e:
    print(f'Correctly raised error: {e}')

# Clean up
manager.close_all()
import shutil
shutil.rmtree(temp_dir)
print('All project driver tests passed!')
"
```
  </verify>
  <done>
GraphManager creates KuzuDriver instances for both global and project scopes, maintains singleton per scope, handles project switching, creates necessary directories, and provides clean shutdown via close_all().
  </done>
</task>

<task type="auto">
  <name>Task 3: Export storage layer public API</name>
  <files>
    src/storage/__init__.py
  </files>
  <action>
Update src/storage/__init__.py to export the public API:
```python
from src.storage.selector import GraphSelector
from src.storage.graph_manager import GraphManager

__all__ = ["GraphSelector", "GraphManager"]
```

This establishes the clean public interface for the storage layer.
  </action>
  <verify>
```bash
python -c "
from src.storage import GraphSelector, GraphManager
print(f'GraphSelector: {GraphSelector}')
print(f'GraphManager: {GraphManager}')
print('Storage layer exports working!')
"
```
  </verify>
  <done>
src.storage module exports GraphSelector and GraphManager as its public API.
  </done>
</task>

</tasks>

<verification>
All verification commands from tasks pass:
1. GraphSelector finds project roots correctly and routes scopes appropriately
2. GraphSelector returns None and falls back to GLOBAL outside git repos
3. GraphManager creates KuzuDriver for global scope at ~/.graphiti/global/graphiti.kuzu
4. GraphManager creates KuzuDriver for project scope at {project_root}/.graphiti/graphiti.kuzu
5. GraphManager maintains singleton instances and handles project switching
6. Storage layer exports are accessible
</verification>

<success_criteria>
- GraphSelector.find_project_root() detects .git directories walking up tree
- GraphSelector.determine_scope() routes preferences to GLOBAL, other ops to PROJECT when available
- GraphManager.get_driver(GLOBAL) creates driver at correct global path
- GraphManager.get_driver(PROJECT, root) creates driver at correct project path
- Singleton pattern ensures same driver instance returned for same scope
- Project switching closes old driver and creates new one
- src.storage module exports both classes
</success_criteria>

<output>
After completion, create `.planning/phases/01-storage-foundation/01-02-SUMMARY.md`
</output>
