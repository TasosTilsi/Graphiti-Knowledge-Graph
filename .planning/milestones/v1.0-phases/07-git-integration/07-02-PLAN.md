---
phase: 07-git-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/gitops/config.py
  - src/gitops/lfs.py
autonomous: true

must_haves:
  truths:
    - ".graphiti/.gitignore excludes queue.db, temp files, locks, and rebuild markers"
    - ".gitattributes configures LFS tracking for .graphiti/database/** binary files"
    - "LFS availability is detected and missing LFS triggers rebuild-from-journal fallback"
    - "LFS pointer files are correctly identified to prevent loading text as binary DB"
  artifacts:
    - path: "src/gitops/config.py"
      provides: "Git configuration file generators for .gitignore and .gitattributes"
      exports: ["generate_gitignore", "generate_gitattributes", "ensure_git_config"]
    - path: "src/gitops/lfs.py"
      provides: "Git LFS detection, pointer checking, and setup helpers"
      exports: ["is_lfs_available", "is_lfs_pointer", "setup_lfs_tracking", "ensure_database_available"]
  key_links:
    - from: "src/gitops/config.py"
      to: ".graphiti/.gitignore"
      via: "file write"
      pattern: "write_text.*gitignore"
    - from: "src/gitops/lfs.py"
      to: "git lfs"
      via: "subprocess.run"
      pattern: "subprocess\\.run.*git.*lfs"
---

<objective>
Create git configuration file generators and Git LFS integration for safe graph storage.

Purpose: Proper .gitignore prevents transient files (queue, locks) from entering git. .gitattributes with LFS tracking keeps binary database files out of the main git history. LFS detection with journal-rebuild fallback ensures the system works even without LFS installed.

Output: Configuration generators for .gitignore/.gitattributes and LFS detection/setup utilities.
</objective>

<execution_context>
@/home/tasostilsi/.claude/get-shit-done/workflows/execute-plan.md
@/home/tasostilsi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-git-integration/07-CONTEXT.md
@.planning/phases/07-git-integration/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create git configuration file generators</name>
  <files>src/gitops/config.py</files>
  <action>
    Create `src/gitops/config.py` with:

    **GRAPHITI_GITIGNORE constant** (multiline string):
    ```
    # Graphiti Knowledge Graph - Git Ignores
    # Transient per-developer state (not shared)

    # SQLite queue database (per-developer processing state)
    queue.db
    queue.db-wal
    queue.db-shm

    # Temporary files
    *.tmp
    *.lock

    # Rebuild-in-progress markers
    .rebuilding

    # Debug and log artifacts
    *.log
    audit.log
    ```

    **GRAPHITI_GITATTRIBUTES constant** (multiline string):
    ```
    # Graphiti Knowledge Graph - Git Attributes
    # LFS tracking for binary database files

    .graphiti/database/** filter=lfs diff=lfs merge=lfs -text
    ```

    **generate_gitignore(project_root: Path) -> Path:**
    - Target: `project_root / ".graphiti" / ".gitignore"`
    - Create .graphiti directory if needed
    - Write GRAPHITI_GITIGNORE content
    - Return path to created file

    **generate_gitattributes(project_root: Path) -> Path:**
    - Target: `project_root / ".gitattributes"`
    - If file exists, check if LFS tracking line already present (avoid duplicates)
    - If present, skip. If not, append the LFS tracking line with a header comment
    - If file doesn't exist, create with GRAPHITI_GITATTRIBUTES content
    - Return path to file

    **ensure_git_config(project_root: Path) -> dict[str, bool]:**
    - Call generate_gitignore and generate_gitattributes
    - Return dict with `{"gitignore": True/False, "gitattributes": True/False}` indicating if each was created/updated
    - Catch and log errors, never raise (best-effort pattern matching project convention)
  </action>
  <verify>
    ```bash
    cd /home/tasostilsi/Development/Projects/graphiti-knowledge-graph
    python -c "
    from src.gitops.config import generate_gitignore, generate_gitattributes, ensure_git_config
    from pathlib import Path
    import tempfile

    with tempfile.TemporaryDirectory() as tmpdir:
        root = Path(tmpdir)
        (root / '.git').mkdir()  # Simulate git repo

        # Test gitignore generation
        gi_path = generate_gitignore(root)
        assert gi_path.exists()
        content = gi_path.read_text()
        assert 'queue.db' in content
        assert '*.tmp' in content
        assert '*.lock' in content

        # Test gitattributes generation
        ga_path = generate_gitattributes(root)
        assert ga_path.exists()
        content = ga_path.read_text()
        assert 'filter=lfs' in content

        # Test idempotent gitattributes (don't duplicate)
        ga_path2 = generate_gitattributes(root)
        content2 = ga_path2.read_text()
        assert content2.count('filter=lfs') == 1

        # Test ensure_git_config
        result = ensure_git_config(root)
        assert result['gitignore'] == True
        assert result['gitattributes'] == True

        print('Config generators OK')
    "
    ```
  </verify>
  <done>.graphiti/.gitignore excludes queue.db, temp files, locks, and logs. .gitattributes configures LFS tracking for database directory. Both generators are idempotent.</done>
</task>

<task type="auto">
  <name>Task 2: Create Git LFS detection and setup helpers</name>
  <files>src/gitops/lfs.py, src/gitops/__init__.py</files>
  <action>
    Create `src/gitops/lfs.py` with:

    **is_lfs_available() -> bool:**
    - Run `subprocess.run(["git", "lfs", "version"], capture_output=True, text=True, timeout=5)`
    - Return True if exit code 0 and "git-lfs" in stdout
    - Return False on CalledProcessError, FileNotFoundError, or TimeoutError

    **is_lfs_pointer(filepath: Path) -> bool:**
    - If file doesn't exist or size > 200 bytes, return False
    - Read content as text (errors='ignore')
    - Return True if starts with "version https://git-lfs.github.com/spec/v1"
    - Return False on any exception

    **setup_lfs_tracking(project_root: Path) -> bool:**
    - Check is_lfs_available() first; if not, log warning and return False
    - Run `git lfs track ".graphiti/database/**"` in project_root directory
    - Return True on success, False on failure
    - Log appropriate messages via structlog

    **ensure_database_available(project_root: Path, rebuild_fn: Callable | None = None) -> bool:**
    - Check if database path exists: `project_root / ".graphiti" / "database"`
    - If DB directory doesn't exist and rebuild_fn provided, call rebuild_fn and return True
    - If DB files exist, check if any are LFS pointers via is_lfs_pointer
    - If LFS pointer detected:
      - If is_lfs_available(): try `git lfs pull` in project_root, return True
      - If not available and rebuild_fn provided: call rebuild_fn, return True
      - If not available and no rebuild_fn: log error with LFS install instructions, return False
    - Return True if DB exists and is not a pointer

    Update `src/gitops/__init__.py` to export: ensure_git_config, is_lfs_available, is_lfs_pointer, setup_lfs_tracking, ensure_database_available plus all exports from Plan 07-01.
  </action>
  <verify>
    ```bash
    cd /home/tasostilsi/Development/Projects/graphiti-knowledge-graph
    python -c "
    from src.gitops.lfs import is_lfs_available, is_lfs_pointer, setup_lfs_tracking
    from pathlib import Path
    import tempfile

    # Test LFS detection
    lfs_available = is_lfs_available()
    print(f'LFS available: {lfs_available}')

    # Test LFS pointer detection
    with tempfile.TemporaryDirectory() as tmpdir:
        root = Path(tmpdir)

        # Create a fake LFS pointer
        pointer_file = root / 'test.db'
        pointer_file.write_text('version https://git-lfs.github.com/spec/v1\noid sha256:abc\nsize 1234')
        assert is_lfs_pointer(pointer_file) == True

        # Create a real file
        real_file = root / 'real.db'
        real_file.write_bytes(b'\\x00' * 300)
        assert is_lfs_pointer(real_file) == False

        # Non-existent file
        assert is_lfs_pointer(root / 'nope.db') == False

        print('LFS helpers OK')
    "
    ```
  </verify>
  <done>LFS detection correctly identifies availability and pointer files. ensure_database_available handles missing LFS with journal rebuild fallback. All gitops exports work.</done>
</task>

</tasks>

<verification>
1. `python -c "from src.gitops import ensure_git_config, is_lfs_available"` succeeds
2. Generated .gitignore contains queue.db, *.tmp, *.lock exclusions
3. Generated .gitattributes contains LFS filter configuration
4. LFS pointer detection correctly identifies pointer vs binary files
5. ensure_database_available handles all scenarios (DB exists, LFS pointer, missing DB)
</verification>

<success_criteria>
- .graphiti/.gitignore generated with all transient file exclusions
- .gitattributes generated with LFS tracking for database directory
- LFS availability detection works cross-platform
- LFS pointer files correctly identified
- Database availability check with rebuild fallback
</success_criteria>

<output>
After completion, create `.planning/phases/07-git-integration/07-02-SUMMARY.md`
</output>
