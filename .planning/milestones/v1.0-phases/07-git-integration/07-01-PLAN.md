---
phase: 07-git-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/gitops/__init__.py
  - src/gitops/journal.py
autonomous: true

must_haves:
  truths:
    - "Journal entries are created as individual timestamped JSON files in .graphiti/journal/"
    - "Each journal entry has a valid Pydantic-enforced schema with version, timestamp, operation, author, and data"
    - "Journal filenames use YYYYMMDD_HHMMSS_<uuid>.json format to prevent collisions"
    - "Git author name and email are automatically captured in journal entries"
  artifacts:
    - path: "src/gitops/__init__.py"
      provides: "Public API for git operations module"
    - path: "src/gitops/journal.py"
      provides: "JournalEntry Pydantic model and create_journal_entry writer"
      exports: ["JournalEntry", "JournalOperation", "JournalAuthor", "create_journal_entry", "list_journal_entries"]
    - path: "pyproject.toml"
      provides: "GitPython and Pydantic dependencies"
      contains: "GitPython"
  key_links:
    - from: "src/gitops/journal.py"
      to: "GitPython"
      via: "git.Repo for author extraction"
      pattern: "git\\.Repo"
    - from: "src/gitops/journal.py"
      to: ".graphiti/journal/*.json"
      via: "file write with json.dumps"
      pattern: "write_text.*json"
---

<objective>
Create the journal entry data model and writer for migration-style timestamped operation logs.

Purpose: Journal entries are the foundational data format for git-safe knowledge graphs. Individual timestamped files eliminate merge conflicts (two devs never edit the same file) and provide an authoritative source of truth that can rebuild the Kuzu database.

Output: Pydantic model for journal entries, writer function that creates timestamped files with git author attribution, and new `src/gitops/` module.
</objective>

<execution_context>
@/home/tasostilsi/.claude/get-shit-done/workflows/execute-plan.md
@/home/tasostilsi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-git-integration/07-CONTEXT.md
@.planning/phases/07-git-integration/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dependencies and create journal entry Pydantic model</name>
  <files>pyproject.toml, src/gitops/__init__.py, src/gitops/journal.py</files>
  <action>
    1. Add `GitPython>=3.1.0` and `pydantic>=2.0.0` to `pyproject.toml` dependencies.

    2. Create `src/gitops/__init__.py` with module docstring and exports for JournalEntry, JournalOperation, JournalAuthor, create_journal_entry, list_journal_entries.

    3. Create `src/gitops/journal.py` with:

    **JournalOperation enum** (str, Enum):
    - `ADD_ENTITY` = "add_entity"
    - `ADD_EDGE` = "add_edge"
    - `UPDATE_ENTITY` = "update_entity"
    - `DELETE_ENTITY` = "delete_entity"
    - `DELETE_EDGE` = "delete_edge"
    - `BULK_IMPORT` = "bulk_import"

    **JournalAuthor** (Pydantic BaseModel):
    - `name: str`
    - `email: str`

    **JournalEntry** (Pydantic BaseModel):
    - `version: str = "1.0"` (schema version, literal "1.0")
    - `timestamp: datetime` (UTC, ISO 8601)
    - `operation: JournalOperation`
    - `author: JournalAuthor`
    - `entity_id: str | None = None` (optional, for targeted operations)
    - `data: dict[str, Any]` (operation-specific payload)

    Configure Pydantic model with `model_config = ConfigDict(frozen=True)` for immutability (consistent with project pattern of frozen dataclasses for important data).

    Use `json_encoders` or Pydantic v2 serialization to ensure datetime serializes as ISO 8601 string.
  </action>
  <verify>
    ```bash
    cd /home/tasostilsi/Development/Projects/graphiti-knowledge-graph
    python -c "
    from src.gitops.journal import JournalEntry, JournalOperation, JournalAuthor
    from datetime import datetime, timezone
    entry = JournalEntry(
        timestamp=datetime.now(timezone.utc),
        operation=JournalOperation.ADD_ENTITY,
        author=JournalAuthor(name='Test', email='test@example.com'),
        data={'name': 'Python', 'summary': 'A programming language'}
    )
    print(entry.model_dump_json(indent=2))
    assert entry.version == '1.0'
    assert entry.operation == JournalOperation.ADD_ENTITY
    print('Model OK')
    "
    ```
  </verify>
  <done>JournalEntry Pydantic model validates and serializes correctly with all required fields, frozen immutability, and ISO 8601 timestamps.</done>
</task>

<task type="auto">
  <name>Task 2: Create journal entry writer with timestamped files and git author</name>
  <files>src/gitops/journal.py</files>
  <action>
    Add to `src/gitops/journal.py`:

    **get_git_author() -> JournalAuthor:**
    - Use `git.Repo(search_parent_directories=True)` to find repo
    - Read `user.name` and `user.email` from git config
    - Return JournalAuthor with those values
    - On any error (not a git repo, no user configured), return JournalAuthor(name="unknown", email="unknown@local")
    - Import git at function level to handle missing GitPython gracefully

    **create_journal_entry(operation, data, entity_id=None, project_root=None) -> Path:**
    - Generate timestamp: `datetime.now(timezone.utc)`
    - Generate filename: `YYYYMMDD_HHMMSS_<uuid6hex>.json` using `datetime.strftime("%Y%m%d_%H%M%S")` + `uuid4().hex[:6]`
    - Determine journal directory: If project_root provided, use `project_root / ".graphiti" / "journal"`, else find project root via storage.GraphSelector or default to current dir
    - Create journal directory with `mkdir(parents=True, exist_ok=True)`
    - Build JournalEntry with auto-detected git author
    - Write JSON to file with `indent=2` for human-readable diffs
    - Return the Path to the created file

    **list_journal_entries(project_root=None) -> list[Path]:**
    - Find journal directory
    - Return `sorted(journal_dir.glob("*.json"))` â€” sorted by filename gives chronological order due to timestamp naming
    - Return empty list if directory doesn't exist

    Important: Use `datetime.now(timezone.utc)` not `datetime.now()` per research (timezone-aware for cross-timezone deterministic sorting). The filename format ensures uniqueness via UUID suffix even if two entries created in the same second.
  </action>
  <verify>
    ```bash
    cd /home/tasostilsi/Development/Projects/graphiti-knowledge-graph
    python -c "
    from src.gitops.journal import create_journal_entry, list_journal_entries, JournalOperation
    from pathlib import Path
    import tempfile, json

    with tempfile.TemporaryDirectory() as tmpdir:
        root = Path(tmpdir)
        # Create a journal entry
        path = create_journal_entry(
            operation=JournalOperation.ADD_ENTITY,
            data={'name': 'Test Entity', 'summary': 'A test'},
            project_root=root
        )
        assert path.exists()
        assert path.parent.name == 'journal'
        assert path.suffix == '.json'

        # Verify content
        content = json.loads(path.read_text())
        assert content['version'] == '1.0'
        assert content['operation'] == 'add_entity'
        assert 'timestamp' in content
        assert 'author' in content
        assert content['data']['name'] == 'Test Entity'

        # Verify listing
        entries = list_journal_entries(project_root=root)
        assert len(entries) == 1
        print(f'Created: {path.name}')
        print(f'Content: {json.dumps(content, indent=2)}')
        print('Writer OK')
    "
    ```
  </verify>
  <done>create_journal_entry creates timestamped JSON files in .graphiti/journal/ with git author attribution, and list_journal_entries returns them in chronological order.</done>
</task>

</tasks>

<verification>
1. `python -c "from src.gitops import JournalEntry, create_journal_entry"` succeeds
2. Journal files have format `YYYYMMDD_HHMMSS_<hex>.json`
3. JSON content validates against Pydantic schema
4. Git author is auto-detected from git config
5. Multiple entries created rapidly have unique filenames (UUID suffix)
</verification>

<success_criteria>
- JournalEntry Pydantic model with version, timestamp, operation, author, data fields
- create_journal_entry writes individual timestamped files to .graphiti/journal/
- list_journal_entries returns sorted list of journal entry paths
- Git author name/email auto-detected via GitPython
- All imports from src.gitops work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/07-git-integration/07-01-SUMMARY.md`
</output>
