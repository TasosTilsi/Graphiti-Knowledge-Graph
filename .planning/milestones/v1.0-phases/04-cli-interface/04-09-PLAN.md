---
phase: 04-cli-interface
plan: 09
type: execute
wave: 2
depends_on: ["04-07"]
files_modified:
  - src/cli/commands/show.py
  - src/cli/commands/delete.py
  - src/cli/commands/summarize.py
  - src/cli/commands/compact.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "graphiti show displays real entity data with actual relationships from the graph"
    - "graphiti delete removes real entities from the Kuzu database"
    - "graphiti summarize generates LLM-powered summary from actual graph entities"
    - "graphiti compact performs real deduplication and cleanup on the graph"
  artifacts:
    - path: "src/cli/commands/show.py"
      provides: "Show command wired to GraphService.get_entity()"
      contains: "from src.graph"
    - path: "src/cli/commands/delete.py"
      provides: "Delete command wired to GraphService.delete_entities()"
      contains: "from src.graph"
    - path: "src/cli/commands/summarize.py"
      provides: "Summarize command wired to GraphService.summarize()"
      contains: "from src.graph"
    - path: "src/cli/commands/compact.py"
      provides: "Compact command wired to GraphService.compact() and get_stats()"
      contains: "from src.graph"
  key_links:
    - from: "src/cli/commands/show.py"
      to: "src/graph/service.py"
      via: "_find_entity calls GraphService.get_entity()"
      pattern: "run_graph_operation|get_service"
    - from: "src/cli/commands/delete.py"
      to: "src/graph/service.py"
      via: "_resolve_entity and _delete_entities call GraphService methods"
      pattern: "run_graph_operation|get_service"
    - from: "src/cli/commands/summarize.py"
      to: "src/graph/service.py"
      via: "_load_entities and _generate_summary call GraphService.summarize()"
      pattern: "run_graph_operation|get_service"
    - from: "src/cli/commands/compact.py"
      to: "src/graph/service.py"
      via: "_get_graph_stats and _compact_graph call GraphService methods"
      pattern: "run_graph_operation|get_service"
---

<objective>
Wire the show, delete, summarize, and compact CLI commands to real graph operations via GraphService, replacing their stub functions.

Purpose: Completes the gap closure by wiring the remaining 4 commands. After this plan, all 7 core operations work end-to-end with real data, satisfying the verification gap.

Output: Modified show.py, delete.py, summarize.py, compact.py with stubs replaced by GraphService calls
</objective>

<execution_context>
@/home/tasostilsi/.claude/get-shit-done/workflows/execute-plan.md
@/home/tasostilsi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-cli-interface/04-07-SUMMARY.md
@src/graph/service.py
@src/cli/commands/show.py
@src/cli/commands/delete.py
@src/cli/commands/summarize.py
@src/cli/commands/compact.py
@src/cli/utils.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire show and delete commands to GraphService</name>
  <files>src/cli/commands/show.py, src/cli/commands/delete.py</files>
  <action>
Replace stub functions in show.py and delete.py with real GraphService calls.

**show.py changes:**

1. Add imports: `from src.graph import get_service, run_graph_operation`; `from pathlib import Path`; `from typing import Optional`

2. Replace `_find_entity()` body (lines ~14-76) with:
   - Accept additional parameters: `scope: GraphScope, project_root: Optional[Path] = None`
   - Call `run_graph_operation(get_service().get_entity(name=name, scope=scope, project_root=project_root))`
   - GraphService.get_entity returns:
     - None if not found -> return empty dict `{}`
     - Single entity dict if unique match -> return it (with id, name, type, scope, created_at, updated_at, tags, content/summary, relationships)
     - List of brief dicts if ambiguous (multiple matches) -> return the list
   - This matches the existing return type contract: `dict | list[dict]`

3. Update `show_command()` to pass scope and project_root to `_find_entity()`:
   - Change `result = _find_entity(entity)` to `result = _find_entity(entity, scope, project_root)` (scope and project_root already resolved on line 91)

4. Remove all mock entity data (the hardcoded entities dict).

5. The ambiguous match re-lookup (`_find_entity(selected_name)` on line 122) should also pass scope/project_root.

6. Keep the rich panel display code unchanged - it already formats whatever dict it receives.

**delete.py changes:**

1. Add imports: `from src.graph import get_service, run_graph_operation`; `from pathlib import Path`; `from typing import Optional`; `from src.models import GraphScope`

2. Replace `_resolve_entity()` body (lines ~13-70) with:
   - Accept additional parameters: `scope: GraphScope, project_root: Optional[Path] = None`
   - Call `run_graph_operation(get_service().get_entity(name=name, scope=scope, project_root=project_root))`
   - Return mapping: None -> None (not found), single dict -> that dict, list -> that list
   - Same return contract as before: `dict | list[dict] | None`

3. Replace `_delete_entities()` body (lines ~73-85) with:
   - Accept additional parameters: `scope: GraphScope, project_root: Optional[Path] = None`
   - Extract entity names/uuids from the entities list
   - Call `run_graph_operation(get_service().delete_entities(names=[e["name"] for e in entities], scope=scope, project_root=project_root))`
   - Return the count (int) of deleted entities

4. Update `delete_command()` to pass scope and project_root to both functions:
   - `_resolve_entity(entity_name)` -> `_resolve_entity(entity_name, scope, project_root)` (line 107)
   - `_delete_entities(resolved_entities)` -> `_delete_entities(resolved_entities, scope, project_root)` (line 162)
   - scope and project_root already resolved on line 102

5. Remove all mock entity data.
  </action>
  <verify>
Run: `cd /home/tasostilsi/Development/Projects/graphiti-knowledge-graph && python -c "
from src.cli.commands.show import _find_entity
from src.cli.commands.delete import _resolve_entity, _delete_entities
import inspect
show_src = inspect.getsource(_find_entity)
resolve_src = inspect.getsource(_resolve_entity)
delete_src = inspect.getsource(_delete_entities)
for name, src in [('show', show_src), ('resolve', resolve_src), ('delete', delete_src)]:
    assert 'mock' not in src.lower() and 'stub' not in src.lower(), f'{name} still has stub'
    assert 'get_service' in src or 'run_graph_operation' in src, f'{name} not wired'
print('show.py and delete.py wired OK')
"` should confirm both are wired with no stubs.
  </verify>
  <done>_find_entity() queries real graph via GraphService.get_entity(). _resolve_entity() and _delete_entities() perform real lookups and deletions via GraphService. No mock data remains.</done>
</task>

<task type="auto">
  <name>Task 2: Wire summarize and compact commands to GraphService</name>
  <files>src/cli/commands/summarize.py, src/cli/commands/compact.py</files>
  <action>
Replace stub functions in summarize.py and compact.py with real GraphService calls.

**summarize.py changes:**

1. Add imports: `from src.graph import get_service, run_graph_operation`; `from pathlib import Path`

2. Replace `_load_entities()` body (lines ~16-53) with:
   - Accept additional parameter: `project_root: Optional[Path] = None`
   - Call `run_graph_operation(get_service().list_entities(scope=scope, project_root=project_root, limit=None))`
   - If topic is provided, filter results: `[e for e in entities if topic.lower() in e.get("name", "").lower() or topic.lower() in e.get("summary", "").lower()]`
   - Return filtered list of entity dicts

3. Replace `_generate_summary()` body (lines ~56-116) with:
   - Call `run_graph_operation(get_service().summarize(scope=scope, project_root=project_root, topic=topic))`
   - GraphService.summarize() returns tuple[str, int] - (summary_text, entity_count)
   - Return just the summary_text string

4. Alternative simpler approach: Combine _load_entities and _generate_summary into a single flow:
   - Keep _load_entities to get entity list for the count display
   - Replace _generate_summary to call GraphService.summarize() which handles both loading and LLM generation internally
   - Or, make _generate_summary accept scope/project_root params and call the service directly

5. Update `summarize_command()` to pass project_root to both functions. The scope and _ = resolve_scope() on line 153 should become scope, project_root = resolve_scope().

6. Remove all mock summary text and mock entity data.

7. Keep the LLMUnavailableError handling (already present at line 205-210) - it correctly shows error and suggests `graphiti health`.

**compact.py changes:**

1. Add imports: `from src.graph import get_service, run_graph_operation`; `from pathlib import Path`; `from typing import Optional`

2. Replace `_get_graph_stats()` body (lines ~14-40) with:
   - Accept additional parameter: `project_root: Optional[Path] = None`
   - Call `run_graph_operation(get_service().get_stats(scope=scope, project_root=project_root))`
   - Return dict with: entity_count, relationship_count, duplicate_count, size_bytes

3. Replace `_compact_graph()` body (lines ~43-64) with:
   - Accept additional parameter: `project_root: Optional[Path] = None`
   - Call `run_graph_operation(get_service().compact(scope=scope, project_root=project_root))`
   - Return dict with: merged_count, removed_count, new_entity_count, new_size_bytes

4. Update `compact_command()` to pass project_root:
   - Line 106: `scope, _ = resolve_scope(...)` -> `scope, project_root = resolve_scope(...)`
   - Line 109: `stats = _get_graph_stats(scope)` -> `stats = _get_graph_stats(scope, project_root)`
   - Line 148: `result = _compact_graph(scope)` -> `result = _compact_graph(scope, project_root)`

5. Remove all mock statistics data.

6. Keep the confirmation flow (confirm_action) and rich output formatting unchanged - those are production-ready.
  </action>
  <verify>
Run: `cd /home/tasostilsi/Development/Projects/graphiti-knowledge-graph && python -c "
from src.cli.commands.summarize import _load_entities, _generate_summary
from src.cli.commands.compact import _get_graph_stats, _compact_graph
import inspect
for name, fn in [('load_entities', _load_entities), ('generate_summary', _generate_summary), ('get_stats', _get_graph_stats), ('compact', _compact_graph)]:
    src = inspect.getsource(fn)
    assert 'mock' not in src.lower() and 'stub' not in src.lower(), f'{name} still has stub'
    assert 'get_service' in src or 'run_graph_operation' in src, f'{name} not wired'
print('summarize.py and compact.py wired OK')
"` should confirm both are wired with no stubs.
  </verify>
  <done>_load_entities() queries real graph for entity listing. _generate_summary() generates real LLM-powered summaries via GraphService. _get_graph_stats() returns real database statistics. _compact_graph() performs real deduplication. No mock data in any function.</done>
</task>

</tasks>

<verification>
1. `grep -rn "mock\|stub\|Mock\|Stub\|hardcoded\|TODO.*Wire" src/cli/commands/show.py src/cli/commands/delete.py src/cli/commands/summarize.py src/cli/commands/compact.py` returns 0 matches (no remaining stubs)
2. `grep -c "get_service\|run_graph_operation" src/cli/commands/show.py src/cli/commands/delete.py src/cli/commands/summarize.py src/cli/commands/compact.py` shows at least 1 for each file
3. All 7 command files now import from src.graph: `grep -l "from src.graph" src/cli/commands/*.py` shows add.py, search.py, list_cmd.py, show.py, delete.py, summarize.py, compact.py
4. `python -c "from src.cli.commands import show, delete, summarize, compact; print('All 4 commands import OK')"` succeeds
</verification>

<success_criteria>
- show.py _find_entity() queries real graph for entity details with relationships
- delete.py _resolve_entity() and _delete_entities() perform real graph mutations
- summarize.py _generate_summary() calls real LLM for summary generation
- compact.py _compact_graph() performs real graph deduplication
- No mock data, stub references, or TODO:Wire comments remain in any of the 4 files
- All commands maintain their existing CLI interface (flags, output format, confirmation prompts)
- Error handling covers LLMUnavailableError and graph connection failures
</success_criteria>

<output>
After completion, create `.planning/phases/04-cli-interface/04-09-SUMMARY.md`
</output>
