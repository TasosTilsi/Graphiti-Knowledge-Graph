---
phase: 7.1-git-indexing-pivot-inserted
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/gitops/journal.py
  - src/gitops/lfs.py
  - src/gitops/checkpoint.py
  - src/gitops/replay.py
  - src/gitops/autoheal.py
  - src/gitops/compact.py
  - src/gitops/__init__.py
  - src/gitops/config.py
  - src/gitops/hooks.py
  - src/cli/commands/compact.py
autonomous: true
requirements:
  - R8.1
  - R8.2

must_haves:
  truths:
    - "Journal, LFS, checkpoint, replay, autoheal, and compact modules are absent from the codebase"
    - "src/gitops/ remains a valid Python package with config.py and hooks.py still present (trimmed)"
    - "gitops/config.py no longer exports generate_gitattributes() or any LFS constant"
    - "gitops/hooks.py exposes scan_staged_secrets() and check_graphiti_size() (no journal-specific functions)"
    - "graphiti compact command has no --journal, --ttl-days, or --dry-run flags and no gitops.compact import"
    - "Import of any deleted module raises ImportError"
  artifacts:
    - path: "src/gitops/__init__.py"
      provides: "Clean exports — only config and surviving hooks functions"
      contains: "from src.gitops.config"
    - path: "src/gitops/hooks.py"
      provides: "scan_staged_secrets() and check_graphiti_size() only"
      exports: ["scan_staged_secrets", "check_graphiti_size"]
    - path: "src/gitops/config.py"
      provides: "generate_gitignore() and ensure_git_config() without LFS parts"
      contains: "generate_gitignore"
    - path: "src/cli/commands/compact.py"
      provides: "Graph-only compact command with no journal flags"
  key_links:
    - from: "src/gitops/__init__.py"
      to: "src/gitops/config.py and src/gitops/hooks.py"
      via: "Python import"
      pattern: "from src\\.gitops\\.(config|hooks)"
    - from: "src/cli/commands/compact.py"
      to: "src/graph/service.py"
      via: "GraphService.compact() call (no gitops.compact import)"
      pattern: "GraphService|graph_service"
---

<objective>
Remove all journal-based Phase 7 components from the codebase. Delete six module files entirely and surgically trim three surviving gitops modules and the compact CLI command.

Purpose: The architectural pivot to local-first indexing requires these modules to be gone before the new indexer is built. Removing them first ensures no lingering journal references exist when the indexer is introduced.

Output: Clean gitops package with only the general-purpose pieces surviving (gitignore generation, secrets scanning, size checking). Compact command becomes graph-deduplication-only.
</objective>

<execution_context>
@/home/tasostilsi/.claude/get-shit-done/workflows/execute-plan.md
@/home/tasostilsi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/7.1-git-indexing-pivot-inserted/7.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete six journal module files and clean up gitops package exports</name>
  <files>
    src/gitops/journal.py
    src/gitops/lfs.py
    src/gitops/checkpoint.py
    src/gitops/replay.py
    src/gitops/autoheal.py
    src/gitops/compact.py
    src/gitops/__init__.py
  </files>
  <action>
Delete these six files entirely — their entire purpose is removed by the architectural pivot:
- `src/gitops/journal.py` — JournalEntry model and timestamped file writer
- `src/gitops/lfs.py` — LFS detection and setup helpers
- `src/gitops/checkpoint.py` — checkpoint tracking
- `src/gitops/replay.py` — journal replay engine
- `src/gitops/autoheal.py` — post-merge journal auto-heal
- `src/gitops/compact.py` — journal compaction

Then rewrite `src/gitops/__init__.py` to export only what survives. Read the current __init__.py first to understand its current exports. The new __init__.py should import only from `src.gitops.config` (generate_gitignore, ensure_git_config) and `src.gitops.hooks` (scan_staged_secrets, check_graphiti_size). Remove all imports and re-exports of the deleted modules. Keep the module docstring but update it to describe the new scope (general git hygiene utilities — gitignore generation, secret scanning, size checking).

Verify deletion: `python -c "from src.gitops import journal"` must raise ImportError.
Verify exports: `python -c "from src.gitops import scan_staged_secrets, check_graphiti_size"` must succeed (the hooks functions will be renamed in Task 2, but at minimum the __init__.py must not reference deleted modules).
  </action>
  <verify>
cd /home/tasostilsi/Development/Projects/graphiti-knowledge-graph && python -c "
import sys
# Verify deleted modules are gone
for mod in ['journal', 'lfs', 'checkpoint', 'replay', 'autoheal', 'compact']:
    try:
        __import__(f'src.gitops.{mod}')
        print(f'FAIL: src.gitops.{mod} still importable')
        sys.exit(1)
    except ImportError:
        print(f'OK: src.gitops.{mod} deleted')
# Verify package still importable
import src.gitops
print('OK: src.gitops package still importable')
"
  </verify>
  <done>Six module files deleted from disk. src/gitops/__init__.py contains no references to deleted modules and imports only from config and hooks submodules. Running the verification script prints all OK lines and exits 0.</done>
</task>

<task type="auto">
  <name>Task 2: Surgically trim gitops/config.py, gitops/hooks.py, and cli/commands/compact.py</name>
  <files>
    src/gitops/config.py
    src/gitops/hooks.py
    src/cli/commands/compact.py
  </files>
  <action>
Read each file first, then make targeted removals:

**src/gitops/config.py:**
- Remove `generate_gitattributes()` function entirely (was used for LFS tracking)
- Remove the `GRAPHITI_GITATTRIBUTES` string constant (LFS tracking lines)
- Remove any `lfs` import or reference
- Keep `generate_gitignore()`, `ensure_git_config()` (gitignore sections only), and any git config helper that does NOT involve LFS
- If `ensure_git_config()` calls any LFS sub-function, remove those call sites but keep the function itself for gitignore-related git config
- Update module docstring to describe surviving scope

**src/gitops/hooks.py:**
- Remove `stage_journal_entries()` — was used to auto-stage journal files in pre-commit
- Remove `validate_journal_schemas()` — was used to check journal Pydantic schemas in pre-commit
- Remove `scan_journal_secrets()` — replaced by broader `scan_staged_secrets()`
- Remove `run_precommit_validation()` — the journal-specific orchestration function
- RENAME (if present) any journal-specific secret scanner to `scan_staged_secrets()` — it should scan ALL staged files (not just journal/), using the existing detect-secrets baseline approach. If the old function already accepts arbitrary paths, just rename it and update its docstring.
- Keep `check_graphiti_size()` unchanged
- Update module docstring: "Git hook helper functions for general repo hygiene. Provides staged file secret scanning and repository size checking. Journal-specific functions removed in Phase 7.1."
- After edits, update src/gitops/__init__.py to export `scan_staged_secrets` (the renamed function) and `check_graphiti_size`

**src/cli/commands/compact.py:**
- Read the current file — it has `--journal`, `--ttl-days`, `--dry-run` Typer options
- Remove the `--journal` / `--ttl-days` / `--dry-run` option parameters from the `compact_command` function signature
- Remove any `from src.gitops.compact import ...` import at the top
- Remove any code paths that call journal compaction functions
- The remaining command body should only perform graph-level deduplication (calls to `GraphService.compact()` or equivalent). Check the current file — if journal compaction was the only body, replace the body with `GraphService.compact()` call (which already exists for entity deduplication from Phase 4-11)
- Update the command docstring: "Compact the knowledge graph by merging duplicate entities."
  </action>
  <verify>
cd /home/tasostilsi/Development/Projects/graphiti-knowledge-graph && python -c "
# Verify config.py has no LFS exports
from src.gitops.config import generate_gitignore
assert callable(generate_gitignore), 'generate_gitignore missing'
try:
    from src.gitops.config import generate_gitattributes
    print('FAIL: generate_gitattributes still exists')
    raise SystemExit(1)
except ImportError:
    print('OK: generate_gitattributes removed')

# Verify hooks.py has scan_staged_secrets and check_graphiti_size
from src.gitops.hooks import scan_staged_secrets, check_graphiti_size
print('OK: scan_staged_secrets and check_graphiti_size importable')

# Verify compact command has no journal flags
import inspect
from src.cli.commands.compact import compact_command
sig = str(inspect.signature(compact_command))
assert 'journal' not in sig, f'journal flag still in compact: {sig}'
assert 'ttl_days' not in sig, f'ttl_days flag still in compact: {sig}'
print('OK: compact command has no journal flags')
" && python -m pytest /home/tasostilsi/Development/Projects/graphiti-knowledge-graph/tests/ -x -q --ignore=tests/integration 2>&1 | tail -20
  </verify>
  <done>config.py has no generate_gitattributes. hooks.py exports scan_staged_secrets and check_graphiti_size. compact_command signature has no --journal, --ttl-days, or --dry-run parameters. No import errors from src.gitops package. Existing test suite passes (or failures are only in tests that directly tested the now-deleted modules — those test files should also be deleted if they test only deleted modules).</done>
</task>

</tasks>

<verification>
Full phase removal verification:
1. `python -c "from src.gitops import journal"` raises ImportError
2. `python -c "from src.gitops import scan_staged_secrets, check_graphiti_size"` succeeds
3. `python -c "from src.gitops.config import generate_gitignore"` succeeds
4. `python -c "from src.gitops.config import generate_gitattributes"` raises ImportError
5. `python -c "from src.cli.commands.compact import compact_command; import inspect; sig = inspect.signature(compact_command); assert 'journal' not in str(sig)"` succeeds
6. `grep -r "gitops.journal\|gitops.lfs\|gitops.checkpoint\|gitops.replay\|gitops.autoheal\|gitops.compact" src/` returns no matches (except any test files for those deleted modules which should also be deleted)
</verification>

<success_criteria>
The six Phase 7 journal modules are gone from disk. The surviving gitops package contains only general-purpose git hygiene utilities. The compact CLI command has no journal-specific flags. The codebase compiles and imports without errors. No source file references the deleted module paths.
</success_criteria>

<output>
After completion, create `.planning/phases/7.1-git-indexing-pivot-inserted/7.1-01-SUMMARY.md`
</output>
