---
phase: 7.1-git-indexing-pivot-inserted
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/templates/pre-commit.sh
  - src/hooks/templates/post-merge.sh
  - src/hooks/templates/post-checkout.sh
  - src/hooks/templates/post-rewrite.sh
  - src/hooks/installer.py
autonomous: true
requirements:
  - R8.1
  - R8.2

must_haves:
  truths:
    - "post-merge.sh triggers background graphiti index (not journal replay)"
    - "post-checkout.sh exits early when $3=0 (file checkout) and only triggers indexing on branch switch ($3=1)"
    - "post-rewrite.sh triggers background graphiti index after rebase/amend"
    - "pre-commit.sh runs secrets scanning and size checking but has no journal staging or schema validation"
    - "All four hook templates use (graphiti index >/dev/null 2>&1) & pattern for non-blocking background execution"
    - "hooks/installer.py exposes install_postcheckout_hook() and install_postrewrite_hook() functions"
    - "hooks/installer.py exposes upgrade_postmerge_hook() to replace old autoheal-based post-merge with new indexer-based one"
    - "Hook templates include GRAPHITI_SKIP=1 early exit guard"
  artifacts:
    - path: "src/hooks/templates/post-merge.sh"
      provides: "Background graphiti index on git merge"
      contains: "graphiti index"
    - path: "src/hooks/templates/post-checkout.sh"
      provides: "Background graphiti index on branch switch only"
      contains: '[ "$3" = "0" ] && exit 0'
    - path: "src/hooks/templates/post-rewrite.sh"
      provides: "Background graphiti index after rebase/amend"
      contains: "graphiti index"
    - path: "src/hooks/templates/pre-commit.sh"
      provides: "Secrets scanning and size check without journal functions"
    - path: "src/hooks/installer.py"
      provides: "install_postcheckout_hook, install_postrewrite_hook, upgrade_postmerge_hook"
      exports: ["install_postcheckout_hook", "install_postrewrite_hook", "upgrade_postmerge_hook"]
  key_links:
    - from: "src/hooks/templates/post-checkout.sh"
      to: "graphiti index CLI"
      via: "background subshell: (graphiti index >/dev/null 2>&1) &"
      pattern: "graphiti index"
    - from: "src/hooks/installer.py"
      to: "src/hooks/templates/post-checkout.sh"
      via: "template path read by install_postcheckout_hook()"
      pattern: "post-checkout"
    - from: "src/hooks/installer.py"
      to: "src/hooks/templates/post-merge.sh"
      via: "upgrade_postmerge_hook() replaces old autoheal section with new indexer template"
      pattern: "upgrade_postmerge"
---

<objective>
Replace and create hook templates so git events trigger background indexing instead of journal operations. Extend hooks/installer.py to install the two new hook types and provide an upgrade path for existing Phase 7 post-merge hook installations.

Purpose: The git hooks are the automatic trigger mechanism for the indexer. Without them, users must manually run `graphiti index` after merges and branch switches. The installer upgrade path prevents broken hooks on machines that had Phase 7 hooks installed.

Output: Four up-to-date shell hook templates and an extended installer that can deploy and upgrade all hook types.
</objective>

<execution_context>
@/home/tasostilsi/.claude/get-shit-done/workflows/execute-plan.md
@/home/tasostilsi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/7.1-git-indexing-pivot-inserted/7.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create and update four hook shell templates</name>
  <files>
    src/hooks/templates/pre-commit.sh
    src/hooks/templates/post-merge.sh
    src/hooks/templates/post-checkout.sh
    src/hooks/templates/post-rewrite.sh
  </files>
  <action>
Read the current pre-commit.sh and post-merge.sh to understand the existing marker format and structure, then update or create each template:

**src/hooks/templates/pre-commit.sh** (MODIFY — remove journal parts, keep secrets + size):
Read the existing file. Find and remove:
- Any call to `stage_journal_entries` or equivalent journal staging Python call
- Any call to `validate_journal_schemas` or equivalent schema validation call
- Any import of `src.gitops.journal` or `src.gitops.hooks.run_precommit_validation`

Keep exactly:
- The GRAPHITI_HOOK_START / GRAPHITI_HOOK_END markers (for idempotent detection)
- The GRAPHITI_SKIP=1 early exit guard
- The `command -v graphiti` availability check
- The `hooks.enabled` config check
- The call to secrets scanning (look for how it currently calls the Python function — it may do `graphiti hooks precommit-check` or a direct `python -c` call; keep the secrets and size portions intact)
- The size check call

If the pre-commit hook currently runs a Python function that bundles journal staging + secrets + size, replace it with a call that runs ONLY secrets scanning and size checking. The simplest approach: if the hook currently calls `python -c "from src.gitops.hooks import run_precommit_validation; run_precommit_validation()"`, replace that with separate calls to `scan_staged_secrets` and `check_graphiti_size` directly. Or, if there is a `graphiti` CLI subcommand for pre-commit checks (check if `graphiti hooks precommit` or similar exists), use that instead.

**src/hooks/templates/post-merge.sh** (REPLACE journal content with indexer trigger):
Read the existing file. The current post-merge.sh may call `python -c "from src.gitops.autoheal import auto_heal; auto_heal()"` or similar. Replace the entire content between GRAPHITI_HOOK_START and GRAPHITI_HOOK_END markers with the indexer trigger. Final template:

```sh
#!/bin/sh
# GRAPHITI_HOOK_START
# Graphiti: trigger background index after merge to keep knowledge graph current
[ "$GRAPHITI_SKIP" = "1" ] && exit 0
command -v graphiti >/dev/null 2>&1 || exit 0
graphiti config get hooks.enabled 2>/dev/null | grep -q "true" || exit 0

# Background index — never block the merge operation
(graphiti index >/dev/null 2>&1) &

exit 0
# GRAPHITI_HOOK_END
```

**src/hooks/templates/post-checkout.sh** (NEW — trigger indexer on branch switch only):
Create this file from scratch:

```sh
#!/bin/sh
# GRAPHITI_HOOK_START
# Graphiti: trigger background index on branch switch to keep knowledge graph current
# $3 = 0 means file checkout (not branch switch) — skip
[ "$GRAPHITI_SKIP" = "1" ] && exit 0
command -v graphiti >/dev/null 2>&1 || exit 0

# Only trigger on branch switches ($3=1), not file checkouts ($3=0)
[ "$3" = "0" ] && exit 0

graphiti config get hooks.enabled 2>/dev/null | grep -q "true" || exit 0

# Background index — never block the checkout operation
(graphiti index >/dev/null 2>&1) &

exit 0
# GRAPHITI_HOOK_END
```

**src/hooks/templates/post-rewrite.sh** (NEW — trigger indexer after rebase or amend):
Create this file from scratch:

```sh
#!/bin/sh
# GRAPHITI_HOOK_START
# Graphiti: trigger background index after rebase/amend to re-index rewritten commits
[ "$GRAPHITI_SKIP" = "1" ] && exit 0
command -v graphiti >/dev/null 2>&1 || exit 0
graphiti config get hooks.enabled 2>/dev/null | grep -q "true" || exit 0

# Background index — never block the rebase/amend operation
(graphiti index >/dev/null 2>&1) &

exit 0
# GRAPHITI_HOOK_END
```

After writing all files, make them executable: `chmod +x src/hooks/templates/*.sh`
  </action>
  <verify>
cd /home/tasostilsi/Development/Projects/graphiti-knowledge-graph && \
grep -q "graphiti index" src/hooks/templates/post-merge.sh && echo "OK: post-merge has graphiti index" && \
grep -q 'graphiti index' src/hooks/templates/post-checkout.sh && echo "OK: post-checkout has graphiti index" && \
grep -q '"$3" = "0"' src/hooks/templates/post-checkout.sh && echo "OK: post-checkout checks \$3" && \
grep -q "graphiti index" src/hooks/templates/post-rewrite.sh && echo "OK: post-rewrite has graphiti index" && \
grep -q "GRAPHITI_HOOK_START" src/hooks/templates/pre-commit.sh && echo "OK: pre-commit has markers" && \
! grep -q "stage_journal\|validate_journal\|autoheal\|auto_heal\|run_precommit_validation" src/hooks/templates/pre-commit.sh && echo "OK: pre-commit has no journal references" && \
! grep -q "autoheal\|auto_heal\|journal" src/hooks/templates/post-merge.sh && echo "OK: post-merge has no journal references"
  </verify>
  <done>All four templates exist. post-merge.sh, post-checkout.sh, and post-rewrite.sh all call `graphiti index` in a background subshell. post-checkout.sh checks $3 before triggering. pre-commit.sh contains no journal references. All templates have GRAPHITI_HOOK_START/END markers and GRAPHITI_SKIP=1 guard.</done>
</task>

<task type="auto">
  <name>Task 2: Extend hooks/installer.py with new install functions and upgrade path</name>
  <files>
    src/hooks/installer.py
  </files>
  <action>
Read src/hooks/installer.py in full to understand:
- The `_install_hook(hook_name, template_path, hook_dir)` private helper (or equivalent) — marker-based non-destructive append pattern
- The existing public functions: `install_postcommit_hook()`, `install_postmerge_hook()`, `install_precommit_hook()` (or whatever names exist — read the file)
- The TEMPLATES_DIR path (should be something like `Path(__file__).parent / "templates"`)

Then add these new public functions to installer.py:

**`install_postcheckout_hook(git_dir: Path) -> bool`:**
Call the existing `_install_hook(hook_name="post-checkout", template_path=TEMPLATES_DIR / "post-checkout.sh", hook_dir=git_dir / "hooks")` pattern. Return True on success, False on error. Log with structlog.

**`install_postrewrite_hook(git_dir: Path) -> bool`:**
Same pattern for "post-rewrite" hook type.

**`upgrade_postmerge_hook(git_dir: Path) -> bool`:**
This handles the migration case where Phase 7 installed a post-merge hook that calls `auto_heal` or `src.gitops.autoheal`. The function:
1. Check if `.git/hooks/post-merge` exists
2. Read its content
3. Look for the GRAPHITI_HOOK_START marker (means graphiti installed it)
4. If content between markers contains "autoheal" or "auto_heal" or "journal": this is an old Phase 7 hook — needs upgrade
5. If old hook detected: call `_remove_hook_section(hook_path)` (use existing removal logic if it exists, or implement by reading file, finding GRAPHITI_HOOK_START/END markers, removing that section, writing back) and then call `install_postmerge_hook(git_dir)` to install the new template
6. Return True if upgraded or already up-to-date, False on error
7. Log what happened: "Upgraded post-merge hook from Phase 7 journal replay to Phase 7.1 git indexer"

If the installer does not already have a `_remove_hook_section()` or similar — implement it: read hook file, find lines between GRAPHITI_HOOK_START and GRAPHITI_HOOK_END inclusive, remove them, write back. Handle edge cases: hook has multiple graphiti sections (unlikely but safe to handle by removing all of them).

Also update any existing `install_all_hooks()` or `install_hooks()` umbrella function (if it exists) to include calls to `install_postcheckout_hook()` and `install_postrewrite_hook()` alongside existing hook types. If no umbrella function exists, note this for the CLI command plan (Plan 04) to wire.
  </action>
  <verify>
cd /home/tasostilsi/Development/Projects/graphiti-knowledge-graph && python -c "
from src.hooks.installer import (
    install_postcheckout_hook,
    install_postrewrite_hook,
    upgrade_postmerge_hook,
)
print('OK: install_postcheckout_hook importable')
print('OK: install_postrewrite_hook importable')
print('OK: upgrade_postmerge_hook importable')

import inspect
# Verify they all accept a Path argument (git_dir)
for fn in [install_postcheckout_hook, install_postrewrite_hook, upgrade_postmerge_hook]:
    sig = inspect.signature(fn)
    params = list(sig.parameters.keys())
    assert params, f'{fn.__name__} has no parameters'
    print(f'OK: {fn.__name__} signature: {sig}')
"
  </verify>
  <done>src/hooks/installer.py exports install_postcheckout_hook, install_postrewrite_hook, and upgrade_postmerge_hook. All three functions accept a git_dir Path argument. The functions import without error. The upgrade function contains logic to detect the "autoheal" or "auto_heal" string in existing post-merge hook content.</done>
</task>

</tasks>

<verification>
Full hook templates and installer verification:
1. `grep -c "graphiti index" src/hooks/templates/post-merge.sh` returns >= 1
2. `grep -c '\\[ "\\$3" = "0" \\]' src/hooks/templates/post-checkout.sh` returns >= 1
3. `grep -c "graphiti index" src/hooks/templates/post-rewrite.sh` returns >= 1
4. `grep -c "journal\|autoheal\|stage_journal\|validate_journal" src/hooks/templates/post-merge.sh` returns 0
5. `grep -c "journal\|autoheal\|stage_journal\|validate_journal" src/hooks/templates/pre-commit.sh` returns 0
6. `python -c "from src.hooks.installer import install_postcheckout_hook, install_postrewrite_hook, upgrade_postmerge_hook"` exits 0
</verification>

<success_criteria>
Four hook templates exist and are correctly formed. post-merge.sh, post-checkout.sh, and post-rewrite.sh all use the background subshell pattern for non-blocking git hook execution. post-checkout.sh correctly checks the $3 argument to skip file-level checkouts. pre-commit.sh has no journal references. installer.py has three new public functions for deploying and upgrading hooks.
</success_criteria>

<output>
After completion, create `.planning/phases/7.1-git-indexing-pivot-inserted/7.1-03-SUMMARY.md`
</output>
