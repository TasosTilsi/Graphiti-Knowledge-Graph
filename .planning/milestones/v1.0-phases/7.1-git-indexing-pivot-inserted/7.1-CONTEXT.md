# Phase 7.1: Git Indexing Pivot - Context

**Gathered:** 2026-02-20
**Status:** Ready for planning

<domain>
## Phase Boundary

Replace journal-based git storage with a local-first on-demand git history indexer. Remove journal writer, replay engine, checkpoint tracking, LFS helpers, and journal-specific hooks from Phase 7. Keep Phase 6's capture pipeline entirely intact — it handles real-time forward captures. Add a git history indexer that bootstraps Kuzu from past commits. `.graphiti/` becomes fully gitignored — no knowledge ever leaves the local machine via git.

Scope: removal of journal components + addition of git history indexer + stale detection + auto-triggers. Phase 6 conversation capture and Phase 6 git post-commit capture are unchanged.

</domain>

<decisions>
## Implementation Decisions

### What gets removed from Phase 7
- Journal entry Pydantic model and timestamped file writer (07-01)
- LFS helpers and journal-specific `.gitattributes` entries (from 07-02)
- Checkpoint tracking and incremental replay engine (07-03)
- Journal-specific pre-commit hooks: staging and schema validation (from 07-04)
- Post-merge auto-heal, journal compaction, journal-specific hook templates (07-05)

### What stays from Phase 7
- Pre-commit **secrets scanning** — still valuable, prevents secrets in any committed file
- Pre-commit **size checks** — still useful for general repo health
- `.gitignore` entry for `.graphiti/` — DB stays local
- Git hook installer framework — repurposed for new indexer hooks

### Phase 6 + indexer relationship (no duplication)
- **Indexer** = historical bootstrap (brownfield projects) — processes past commits up to current HEAD
- **Phase 6 post-commit hook** = ongoing real-time capture — captures every new commit going forward
- **SHA-based deduplication**: indexer tracks processed commit SHAs; skips any commit already in Kuzu (whether from Phase 6 or a prior index run)
- **`graphiti index --full`**: wipes all indexed-from-git knowledge and re-processes entire history from scratch — safe to run anytime to rebuild cleanly; Phase 6 captures are NOT affected
- **Greenfield projects**: Phase 6 handles everything from commit #1 — indexer not needed but harmless
- **Brownfield projects**: Run `graphiti index` once to bootstrap history, Phase 6 takes over from that point

### Index extraction

**Data sources per commit:**
- Commit messages
- Commit diffs (actual code changes)
- File-level change patterns (which files change together, churn signals)

**Quality gate — skip these commits entirely (no LLM extraction):**
- Version-bump-only commits (only change version numbers in package.json, pyproject.toml, `__version__`)
- Automated/bot commits (Dependabot, GitHub Actions, CI bots — detected by author email pattern or commit message prefix)
- Pure merge commits (no conflict resolution — empty diff beyond the merge)
- Tiny commits (1–3 lines changed) — typo fixes, whitespace, formatting
- Rationale: version knowledge is captured from richer nearby commits (PRs, changelogs, bug fixes that triggered the bump)

**Large diff handling:**
- Two-pass for commits above a size threshold:
  1. Fast LLM pass: summarize the diff
  2. Extraction pass: structured + free-form extraction on the summary
- Ensures large commits aren't truncated arbitrarily

**Extraction strategy — two-pass per commit:**
1. **Structured Q&A pass**: LLM answers: "What decision was made? What was changed? Why? What files were affected?" — guaranteed consistent baseline fields
2. **Free-form entity extraction pass**: LLM extracts entities and relationships freely — catches signals the structured pass missed
- Both passes' results merged into Kuzu
- Matches Phase 6's entity extraction shape for consistent knowledge across all sources

### Index depth & scope

**Default depth:** Full git history from the beginning — configurable via:
- `index.max_commits` — limit by commit count
- `index.since` — limit by date or SHA
Default is full history; users tune for large or old repos.

**Path scope:** Whole repository by default. Users can add exclusions via config (same `.graphiti/config.toml` pattern as Phase 2 security exclusions).

### graphiti index command

**Modes:**
- `graphiti index` — incremental: only process commits not yet in Kuzu (default, safe to run anytime)
- `graphiti index --full` — wipe all git-indexed knowledge and re-process entire history from scratch
- `graphiti index --since <date or SHA>` — index commits since a specific point (partial re-index window)

**Progress UI while running:**
- Spinner + current commit message being processed
- Example: `⠿ Processing: feat(auth): add JWT validation (commit 7a3f2c1)...`

**Completion summary:**
- Stats: commits processed, entities extracted, time taken
- Highlights: top 3–5 most significant findings (key decisions, architecture changes, important bug fixes found in history)

**Interruption handling:**
- Resume from last processed commit via cursor (last processed SHA stored locally)
- Interrupted run resumes exactly where it stopped — no re-processing already-indexed commits
- `--full` resets the cursor before starting

### Stale detection & auto-triggers

**Index is stale when:**
- Local HEAD has changed (new commits since last index run)
- Remote has new commits not yet indexed (detected on post-merge / post-pull)

**Response to stale detection:**
- Background re-index silently — never blocks the user
- Log completion quietly (no user-facing notification unless `--verbose`)

**Git hooks that trigger stale detection + background re-index:**
- `post-merge` — catches incoming remote commits from teammates (git pull, git merge)
- `post-checkout` — catches branch switches where the new branch has unindexed commits
- `post-rewrite` — catches rebased or amended history
- **NOT post-commit** — that's Phase 6's territory (Phase 6 post-commit hook handles new commits in real-time)

**Rate limiting:**
- Cooldown period between auto-triggers (default: 5 minutes)
- If a background re-index ran within the cooldown window, skip the next auto-trigger
- Prevents rapid-fire LLM calls during active work sessions (multiple checkouts, rebases)

### Claude's Discretion
- Exact SHA cursor storage format (SQLite table, JSON file, or Kuzu metadata)
- Size threshold for triggering the two-pass large-diff summarization
- Exact author/email patterns used for bot commit detection
- Cooldown period storage and expiry mechanism

</decisions>

<specifics>
## Specific Ideas

- "If someone needed to re-index the whole historical knowledge they could do that and not worry if something is missed or not analyzed correctly from Phase 6" — `--full` is the answer to this need
- Version bump commits are skipped, but version knowledge is preserved via surrounding commits (PR merge, changelog, bug fix) — no information lost
- The two-pass extraction (structured + free-form) gives both a consistent baseline AND catches unexpected signals — more LLM calls but richer knowledge than either approach alone

</specifics>

<deferred>
## Deferred Ideas

- None — discussion stayed within phase scope

</deferred>

---

*Phase: 7.1-git-indexing-pivot-inserted*
*Context gathered: 2026-02-20*
