---
phase: 7.1-git-indexing-pivot-inserted
plan: "02"
subsystem: indexer
tags: [gitpython, graphiti-core, structlog, rich, asyncio, kuzu]

# Dependency graph
requires:
  - phase: 7.1-git-indexing-pivot-inserted-01
    provides: Phase 7.1 plan 01 context and pivoted architecture foundation
  - phase: 06-automatic-capture
    provides: fetch_commit_diff() from src/capture/git_capture.py
  - phase: 04-cli-interface
    provides: GraphService, get_service(), GraphScope, _get_graphiti() pattern

provides:
  - src/indexer/ Python package with GitIndexer class and IndexState
  - JSON state management with atomic writes and SHA cursor tracking
  - Commit quality gate filtering bots, tiny diffs, version bumps, pure merges
  - Two-pass LLM extraction pipeline (structured Q&A + free-form entity extraction)
  - Large diff summarization (>300 lines) before LLM extraction passes
  - Crash recovery via per-commit state saves using Path.replace() atomicity

affects: [7.1-03, 8-mcp-server]

# Tech tracking
tech-stack:
  added: [gitpython>=3.1.0 (was in pyproject.toml but uninstalled)]
  patterns:
    - Atomic rename pattern (tmp file + Path.replace()) for state writes
    - Two-pass LLM extraction with tagged source_description per commit
    - SHA 8-char prefix storage (compactness + 10,000-entry cap)
    - Fail-open quality gate (exception during stats check = process commit)
    - asyncio.run() wrapper for async extraction from sync run() method
    - TYPE_CHECKING guard for git.Commit type hints (avoids runtime git import in quality_gate)

key-files:
  created:
    - src/indexer/__init__.py
    - src/indexer/state.py
    - src/indexer/quality_gate.py
    - src/indexer/indexer.py
    - src/indexer/extraction.py
  modified: []

key-decisions:
  - "Store only 8-char SHA prefixes in processed_shas list, capped at 10,000 entries to prevent unbounded growth"
  - "Fail-open quality gate: if stats call raises exception, process the commit rather than skip"
  - "asyncio.run() inside GitIndexer.run() to handle async extraction from sync CLI context"
  - "Two passes per commit: structured Q&A first, then free-form entity extraction - both tagged git-history-index:"
  - "Large diff threshold at 300 lines; summarize before extraction to keep prompts manageable (4000 char limit)"
  - "save_state() after every processed commit for crash recovery at cost of I/O"
  - "reset_full() logs warning if Kuzu episode deletion fails - SHA state cleared so re-indexing proceeds normally"

patterns-established:
  - "Two-pass extraction pattern: structured_pass (Q&A) + freeform_pass (entity facts) per episode source"
  - "Crash-safe state pattern: save after each unit of work, atomic rename prevents corruption"
  - "Quality gate fail-open: exception = assume commit is worth processing (conservative)"

requirements-completed: [R8.1, R8.2]

# Metrics
duration: 4min
completed: 2026-02-20
---

# Phase 7.1 Plan 02: Git History Indexer Core Summary

**GitIndexer Python package with SHA cursor state, bot/noise quality gate, and two-pass LLM extraction pipeline storing structured + freeform episodes tagged git-history-index:**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-20T12:03:41Z
- **Completed:** 2026-02-20T12:07:31Z
- **Tasks:** 2
- **Files modified:** 5 (all created)

## Accomplishments
- IndexState dataclass with atomic JSON persistence via Path.replace() and SHA cursor for incremental runs
- Commit quality gate skipping bots, tiny diffs (<= 3 lines), version-bump-only, and pure merge commits with no diff
- Two-pass async extraction pipeline: structured Q&A + free-form entity extraction per commit, both tagged with `git-history-index:structured:` and `git-history-index:freeform:` source_description prefixes
- Large diff summarization (>300 lines) via src.llm before extraction passes to keep prompts under 4000 chars
- GitIndexer.run() with cooldown check, incremental SHA cursor, quality gate, crash recovery (save after each commit)
- GitIndexer.reset_full() clears disk state and attempts Kuzu episode deletion (warns and continues on failure)

## Task Commits

Each task was committed atomically:

1. **Task 1: Create indexer/state.py and indexer/quality_gate.py** - `128f494` (feat)
2. **Task 2: Create indexer/indexer.py and indexer/extraction.py** - `d8acbbd` (feat)

**Plan metadata:** TBD (docs: complete plan)

## Files Created/Modified
- `src/indexer/__init__.py` - Module init exporting GitIndexer and IndexState
- `src/indexer/state.py` - JSON state management: IndexState dataclass, load/save/cooldown/SHA functions
- `src/indexer/quality_gate.py` - should_skip_commit() quality filter with 5 skip categories
- `src/indexer/indexer.py` - GitIndexer class with run() and reset_full() methods
- `src/indexer/extraction.py` - extract_commit_knowledge() async two-pass LLM extraction pipeline

## Decisions Made
- Stored only 8-char SHA prefixes in processed_shas (compactness), capped at 10,000 to prevent unbounded growth on large repos
- Quality gate fails open: if stats call raises exception (git subprocess error), the commit is processed rather than skipped
- asyncio.run() wraps async extraction inside sync GitIndexer.run() — consistent with how CLI commands invoke graph operations
- Both extraction passes use distinct source_description tags (`git-history-index:structured:` and `git-history-index:freeform:`) for traceability
- Large diff threshold at 300 lines with 4000 char prompt limit matches plan spec exactly
- State saved after every commit (not at end) for crash recovery at I/O cost — acceptable for correctness

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Installed GitPython package that was missing at runtime**
- **Found during:** Task 1 verification
- **Issue:** `import git` raised ModuleNotFoundError despite GitPython being listed in pyproject.toml — package was declared but not installed in the environment
- **Fix:** Ran `pip3 install gitpython --break-system-packages`
- **Files modified:** None (system package install only; pyproject.toml already correct)
- **Verification:** `python3 -c "import git"` succeeds after install
- **Committed in:** 128f494 (part of Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking: missing runtime dependency)
**Impact on plan:** Essential for all indexer modules to import. No scope creep.

## Issues Encountered
- __init__.py imports indexer.py eagerly, so state.py could not be tested in isolation until indexer.py was created. Task 1 verification was deferred until Task 2 files existed. Both verified together before Task 2 commit.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- src/indexer/ package complete and importable
- GitIndexer.run() and reset_full() ready for CLI command integration (7.1-03)
- State file at .graphiti/index-state.json ready for cooldown/cursor tracking
- Two-pass extraction pipeline produces episodes tagged for traceability

---
*Phase: 7.1-git-indexing-pivot-inserted*
*Completed: 2026-02-20*
