---
phase: 7.1-git-indexing-pivot-inserted
plan: "03"
subsystem: git-hooks
tags: [git-hooks, shell, installer, indexer, post-checkout, post-rewrite, post-merge, pre-commit]

# Dependency graph
requires:
  - phase: 7.1-02
    provides: "graphiti index CLI command that hooks invoke in background"
provides:
  - "Four up-to-date git hook shell templates triggering background indexing"
  - "post-checkout.sh: branch-switch-only indexing with $3 guard"
  - "post-rewrite.sh: background indexing after rebase/amend"
  - "post-merge.sh: replaced autoheal with background graphiti index"
  - "pre-commit.sh: secrets+size only (journal references removed)"
  - "install_postcheckout_hook(git_dir) public installer function"
  - "install_postrewrite_hook(git_dir) public installer function"
  - "upgrade_postmerge_hook(git_dir) Phase 7 -> 7.1 migration function"
  - "_remove_hook_section(hook_path) private helper for section removal"
affects:
  - "7.1-04: CLI commands that call install_postcheckout_hook and install_postrewrite_hook"
  - "Phase 8: MCP server assumes hooks are correctly installed"

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "GRAPHITI_SKIP=1 early exit guard on all hook templates"
    - "(graphiti index >/dev/null 2>&1) & pattern for non-blocking background execution"
    - "git_dir: Path parameter convention for hook installer public API"
    - "repo_path derivation from git_dir via parent directory"

key-files:
  created:
    - src/hooks/templates/post-checkout.sh
    - src/hooks/templates/post-rewrite.sh
  modified:
    - src/hooks/templates/pre-commit.sh
    - src/hooks/templates/post-merge.sh
    - src/hooks/installer.py

key-decisions:
  - "post-checkout.sh checks $3 argument: exits 0 when $3=0 (file checkout), only indexes on $3=1 (branch switch)"
  - "upgrade_postmerge_hook detects old Phase 7 hooks by 'autoheal', 'auto_heal', 'journal' string presence"
  - "New installer functions take git_dir: Path (the .git directory) while existing helpers take repo_path â€” new functions derive repo_path via git_dir.parent"
  - "_remove_hook_section handles multiple graphiti sections and malformed (start without end) edge cases"
  - "upgrade_postmerge_hook skips upgrade if GRAPHITI_HOOK_START not present (not installed by graphiti)"

patterns-established:
  - "Non-blocking hook pattern: (graphiti index >/dev/null 2>&1) & always in background subshell"
  - "Hook guard ordering: GRAPHITI_SKIP -> command check -> branch-type check ($3) -> config check -> action"
  - "Phase migration upgrade functions: detect old content by string matching, remove+reinstall pattern"

requirements-completed:
  - R8.1
  - R8.2

# Metrics
duration: 3min
completed: 2026-02-20
---

# Phase 7.1 Plan 03: Hook Templates and Installer Extension Summary

**Four git hook templates updated/created for background graphiti indexing, with installer extended for post-checkout, post-rewrite, and Phase 7 upgrade path**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-20T14:03:44Z
- **Completed:** 2026-02-20T14:06:13Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments

- Replaced post-merge.sh autoheal/journal call with non-blocking `(graphiti index >/dev/null 2>&1) &` trigger
- Created post-checkout.sh with `$3=0` file-checkout guard to only index on branch switches
- Created post-rewrite.sh for background indexing after rebase and amend operations
- Stripped pre-commit.sh of all journal/autoheal references, retaining only secrets scanning and size checking
- Extended installer.py with `install_postcheckout_hook`, `install_postrewrite_hook`, `upgrade_postmerge_hook`, and `_remove_hook_section` helper

## Task Commits

Each task was committed atomically:

1. **Task 1: Create and update four hook shell templates** - `fba0f56` (feat)
2. **Task 2: Extend hooks/installer.py with new install functions and upgrade path** - `780cf38` (feat)

**Plan metadata:** (final commit follows)

## Files Created/Modified

- `src/hooks/templates/post-merge.sh` - Replaced autoheal Python call with background `graphiti index` trigger
- `src/hooks/templates/post-checkout.sh` - NEW: indexes on branch switch ($3=1), skips file checkout ($3=0)
- `src/hooks/templates/post-rewrite.sh` - NEW: background index after rebase/amend
- `src/hooks/templates/pre-commit.sh` - Removed journal staging/schema validation; kept secrets scan + size check
- `src/hooks/installer.py` - Added install_postcheckout_hook, install_postrewrite_hook, upgrade_postmerge_hook, _remove_hook_section

## Decisions Made

- post-checkout.sh checks the `$3` argument in the ordered guard sequence: GRAPHITI_SKIP -> graphiti available -> $3=0 exit -> config enabled -> trigger. The `$3` check happens before the config check to fail fast on file checkouts without a config read.
- New installer public functions use `git_dir: Path` parameter (the .git directory itself) as specified in the plan, deriving `repo_path` via `git_dir.parent if git_dir.name == ".git" else git_dir` for compatibility with the existing `_install_hook` helper.
- `upgrade_postmerge_hook` only operates on hooks that graphiti installed (GRAPHITI_HOOK_START marker present). Third-party post-merge hooks are left untouched.
- `_remove_hook_section` handles edge cases: multiple graphiti sections (removes all), malformed start-without-end (truncates to start), hooks that contain only graphiti content (removes file entirely).

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- All four hook templates correct and executable
- installer.py exports all three required functions (verified by import test)
- Plan 04 (CLI commands) can now wire `install_postcheckout_hook` and `install_postrewrite_hook` into the `graphiti hooks install` command
- `upgrade_postmerge_hook` ready for migration tooling in Plan 04 or as a standalone command

## Self-Check: PASSED

Files verified present:
- FOUND: src/hooks/templates/post-checkout.sh
- FOUND: src/hooks/templates/post-rewrite.sh
- FOUND: src/hooks/templates/post-merge.sh
- FOUND: src/hooks/templates/pre-commit.sh
- FOUND: src/hooks/installer.py
- FOUND: .planning/phases/7.1-git-indexing-pivot-inserted/7.1-03-SUMMARY.md

Commits verified:
- FOUND: fba0f56 (feat(7.1-03): update and create four git hook shell templates)
- FOUND: 780cf38 (feat(7.1-03): extend hooks/installer.py with post-checkout, post-rewrite, and upgrade functions)

---
*Phase: 7.1-git-indexing-pivot-inserted*
*Completed: 2026-02-20*
