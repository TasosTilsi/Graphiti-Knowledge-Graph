# Phase 8.3 Plan 01 — SUMMARY

## What was changed

**File:** `src/queue/worker.py`

### 1. Added `import asyncio` (line 18)
Added at the top of the imports section, after `import subprocess`.

### 2. Modified `_replay_command()` — added job-type dispatch guard
Inserted a dispatch block as the **first thing** in the method, before reading `item['payload']`:

```python
job_type = item.get('job_type', '')
if job_type == 'capture_git_commits':
    success = self._handle_capture_git_commits(item)
    if not success:
        raise RuntimeError(
            f"capture_git_commits handler failed for job {item['id']}: "
            "payload missing 'pending_file' key"
        )
    return
```

### 3. Added `_handle_capture_git_commits()` method
Inserted between `_replay_command()` and `_kwargs_to_flags()`. This method:
- Reads `pending_file` from `item['payload']`
- Returns `False` if `pending_file` is absent/empty (malformed job)
- Calls `asyncio.run(process_pending_commits(pending_file=Path(...)))` for valid jobs
- Returns `True` on successful dispatch

## Why

**Root cause of bug:** `git_worker.enqueue_git_processing()` creates jobs with:
```python
job_type="capture_git_commits", payload={"pending_file": "/path/..."}
```
The old `_replay_command()` unconditionally read `payload.get('command', '')` which returned `""` for this payload shape. This produced `subprocess(['graphiti', ''])` → non-zero exit → `RuntimeError` → 3 retries → dead letter queue.

**Fix strategy:** Job-type dispatch before the generic CLI-replay path. Direct call to `process_pending_commits()` avoids the PATH dependency and is faster.

## Key lines added

- `src/queue/worker.py:18` — `import asyncio`
- `src/queue/worker.py:277` — `if job_type == 'capture_git_commits':` dispatch guard
- `src/queue/worker.py:319` — `def _handle_capture_git_commits(self, item: dict) -> bool:`
- `src/queue/worker.py:362` — `asyncio.run(process_pending_commits(pending_file=pending_file))`

## Verification passed

```
Import OK: BackgroundWorker has _handle_capture_git_commits: True
Import OK: _replay_command exists: True
grep -c "capture_git_commits" src/queue/worker.py → 9 occurrences
grep -n "import asyncio" → line 18
```
