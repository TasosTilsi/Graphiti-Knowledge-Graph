---
phase: 8.2-gap-closure-mcp-server-bugs-inserted
plan: "02"
type: execute
wave: 2
depends_on:
  - "8.2-01"
files_modified:
  - src/cli/commands/add.py
autonomous: true
gap_closure: true
requirements:
  - R4.2

must_haves:
  truths:
    - "_auto_install_hooks() logs a success message when hooks are installed for the first time"
    - "The success log branch is reachable — result.get('git_hook') and result.get('claude_hook') return actual booleans from install_hooks()"
    - "Existing no-op behavior (already installed) is unchanged"
  artifacts:
    - path: "src/cli/commands/add.py"
      provides: "_auto_install_hooks() checking correct dict keys from install_hooks() return value"
      contains: "git_hook"
  key_links:
    - from: "src/cli/commands/add.py"
      to: "src/hooks/manager.py"
      via: "install_hooks() return value"
      pattern: "result\\.get\\(\"git_hook\"\\)"
---

<objective>
Fix the dead-code success log in `_auto_install_hooks()` by correcting two wrong dictionary key names.

`install_hooks()` in `src/hooks/manager.py` returns `{"git_hook": bool, "claude_hook": bool}`. The caller in `src/cli/commands/add.py` checks `result.get("git_installed")` and `result.get("claude_installed")` — keys that never exist in the returned dict. Both calls always return `None` (falsy), so the `if` branch at line 99 is never entered and the `hooks_installed` log event is dead code.

This closes R4.2 (observability): after the fix, successful hook auto-installation is observable via the structured log event.

Purpose: Restore observability for the git post-commit hook auto-install path. The log event `action="hooks_installed"` is the evidence that hooks were installed on first `graphiti add`.
Output: One file corrected — `src/cli/commands/add.py` — with the two wrong key names replaced.
</objective>

<execution_context>
@/home/tasostilsi/.claude/get-shit-done/workflows/execute-plan.md
@/home/tasostilsi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/8.2-gap-closure-mcp-server-bugs-inserted/8.2-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix wrong key names in _auto_install_hooks()</name>
  <files>src/cli/commands/add.py</files>
  <action>
In `src/cli/commands/add.py`, find `_auto_install_hooks()` (starting at line 57). The bug is in the `if` block at line 99 and the two `result.get()` calls inside it (lines 103-104).

`install_hooks()` (from `src/hooks/manager.py`) returns:
```python
{"git_hook": bool, "claude_hook": bool}
```

The current code checks wrong key names:
```python
# CURRENT (broken) — lines 99–105:
if result.get("git_installed") or result.get("claude_installed"):
    logger.info(
        "auto_install_hooks",
        action="hooks_installed",
        git=result.get("git_installed", False),
        claude=result.get("claude_installed", False)
    )
```

Replace with the correct key names:
```python
# FIXED:
if result.get("git_hook") or result.get("claude_hook"):
    logger.info(
        "auto_install_hooks",
        action="hooks_installed",
        git=result.get("git_hook", False),
        claude=result.get("claude_hook", False)
    )
```

That is exactly four substitutions:
- `"git_installed"` → `"git_hook"` (line 99, the `if` condition)
- `"claude_installed"` → `"claude_hook"` (line 99, the `or` operand)
- `"git_installed"` → `"git_hook"` (line 103, the `git=` kwarg)
- `"claude_installed"` → `"claude_hook"` (line 104, the `claude=` kwarg)

No other changes to this file. The surrounding try/except, the `is_git_hook_installed` guard, the `install_hooks()` call arguments, and the warning branch are all correct and must not be touched.
  </action>
  <verify>
Confirm correct keys are present:
```
grep -n 'git_hook\|claude_hook\|git_installed\|claude_installed' src/cli/commands/add.py
```
Expected: Lines containing `"git_hook"` and `"claude_hook"` only. Zero occurrences of `"git_installed"` or `"claude_installed"`.

Confirm the module imports without error:
```
.venv/bin/python -c "from src.cli.commands.add import _auto_install_hooks; print('ok')"
```
Expected: `ok`
  </verify>
  <done>
`src/cli/commands/add.py` has zero occurrences of `"git_installed"` or `"claude_installed"`. The `if` block at line 99 checks `result.get("git_hook") or result.get("claude_hook")`. The module imports without error.
  </done>
</task>

<task type="auto">
  <name>Task 2: Smoke-test all three bug fixes end-to-end</name>
  <files></files>
  <action>
Verify that all three Phase 8.2 bugs are closed by running targeted static checks against the final state of all three files. This task has no file output — it is a verification-only step.

Run the following checks in sequence, capturing output for the summary:

**Check 1 — Bug 1 closed (--async removed):**
```
grep -c '"--async"' src/mcp_server/tools.py
```
Expected output: `0`

**Check 2 — Bug 1 fix present (--quiet in place):**
```
grep -c '"--quiet"' src/mcp_server/tools.py
```
Expected output: `1`

**Check 3 — Bug 2 closed (no bare "graphiti" in subprocess lists in context.py):**
```
grep -c '"graphiti"' src/mcp_server/context.py
```
Expected output: `0`

**Check 4 — Bug 2 fix present (_GRAPHITI_CLI imported and used):**
```
grep -c '_GRAPHITI_CLI' src/mcp_server/context.py
```
Expected output: `4` (1 import + 3 usage sites)

**Check 5 — Bug 3 closed (no wrong key names in add.py):**
```
grep -c 'git_installed\|claude_installed' src/cli/commands/add.py
```
Expected output: `0`

**Check 6 — Bug 3 fix present (correct keys in add.py):**
```
grep -c '"git_hook"\|"claude_hook"' src/cli/commands/add.py
```
Expected output: `4` (2 in the if condition, 2 in the logger.info kwargs)

**Check 7 — All three modules import cleanly:**
```
.venv/bin/python -c "
from src.mcp_server import tools, context
from src.cli.commands.add import _auto_install_hooks
print('all imports ok')
"
```
Expected output: `all imports ok`

If any check fails, diagnose and fix in the relevant file before proceeding to summary.
  </action>
  <verify>
All seven checks above return expected values. `all imports ok` is printed without exception.
  </verify>
  <done>
All three Phase 8.2 bugs confirmed closed by static check:
- tools.py: `--async` gone, `--quiet` present
- context.py: bare `"graphiti"` gone, `_GRAPHITI_CLI` used in all three call sites
- add.py: `git_installed`/`claude_installed` gone, `git_hook`/`claude_hook` present
All three modules import without error.
  </done>
</task>

</tasks>

<verification>
Final state check across all three changed files:

```
# Bug 1
grep -n '"--async"\|"--quiet"' src/mcp_server/tools.py

# Bug 2
grep -n '"graphiti"\|_GRAPHITI_CLI' src/mcp_server/context.py

# Bug 3
grep -n 'git_installed\|claude_installed\|git_hook\|claude_hook' src/cli/commands/add.py

# Clean imports
.venv/bin/python -c "
from src.mcp_server import tools, context
from src.cli.commands.add import _auto_install_hooks
print('Phase 8.2 complete')
"
```

Expected final output: `Phase 8.2 complete` with no import errors.
</verification>

<success_criteria>
- `_auto_install_hooks()` checks `result.get("git_hook")` and `result.get("claude_hook")` — both return actual booleans from `install_hooks()`, making the success log reachable
- The `action="hooks_installed"` structlog event fires correctly when hooks are newly installed during `graphiti add`
- All three Phase 8.2 bug-fix files pass the smoke-test checks in Task 2
- R4.2 observability closed: hook auto-install success is no longer silent dead code
</success_criteria>

<output>
After completion, create `.planning/phases/8.2-gap-closure-mcp-server-bugs-inserted/8.2-02-SUMMARY.md` following the GSD summary template.

Also commit all changes for Phase 8.2:
```
git add src/mcp_server/tools.py src/mcp_server/context.py src/cli/commands/add.py
git commit -m "fix(mcp): close Phase 8.2 bugs — capture --async, context.py path, hooks key names

- tools.py: replace --async with --quiet in graphiti_capture() Popen call
- context.py: import _GRAPHITI_CLI from tools.py; replace all bare \"graphiti\" subprocess args
- add.py: fix _auto_install_hooks() to check git_hook/claude_hook keys (not git_installed/claude_installed)

Closes R6.3, R6.2, R4.2"
```
</output>
