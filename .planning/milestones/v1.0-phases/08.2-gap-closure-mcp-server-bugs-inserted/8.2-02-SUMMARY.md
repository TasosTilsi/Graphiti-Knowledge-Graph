---
phase: 08.2-gap-closure-mcp-server-bugs-inserted
plan: "02"
subsystem: cli
tags: [bug-fix, hooks, observability, dead-code, gap-closure]

requires:
  - phase: 08.2-plan-01
    provides: tools.py and context.py fixes from Plan 01

provides:
  - add.py with _auto_install_hooks() checking correct dict keys from install_hooks()
  - R4.2 closed: hook auto-install success is now observable (hooks_installed log event reachable)

affects:
  - R4.2 (observability: action="hooks_installed" structlog event now fires correctly)

tech-stack:
  added: []
  patterns:
    - dict-key-correctness: result.get("git_hook") / result.get("claude_hook") matching install_hooks() return value

key-files:
  modified:
    - src/cli/commands/add.py

key-decisions:
  - "Replace git_installed/claude_installed with git_hook/claude_hook: these are the actual keys returned by install_hooks() in src/hooks/manager.py (line 130)"
  - "Four substitutions required: the if condition (2 keys) and the logger.info kwargs (2 keys)"

requirements-completed: [R4.2]

duration: 5min
completed: 2026-02-24
---

# Phase 8.2 Plan 02: Fix _auto_install_hooks() Key Names

**Dead-code success log in _auto_install_hooks() restored by correcting two wrong dictionary key names — hooks_installed log event is now reachable**

## Performance

- **Duration:** ~5 min
- **Started:** 2026-02-24
- **Completed:** 2026-02-24
- **Tasks:** 2 completed (fix + smoke-test)
- **Files modified:** 1

## Accomplishments

- Fixed `src/cli/commands/add.py`: replaced all four occurrences of the wrong key names (`"git_installed"`, `"claude_installed"`) with the correct keys (`"git_hook"`, `"claude_hook"`) that `install_hooks()` actually returns.
- The `if` branch at the original line 99 was dead code because `result.get("git_installed")` always returned `None` — the key never existed. After the fix, the branch is reachable and the `action="hooks_installed"` structlog event fires when hooks are newly installed.
- Confirmed `src/hooks/manager.py` returns `{"git_hook": bool, "claude_hook": bool}` (line 130), validating the fix.

## Task Commits

1. **Task 1: Fix wrong key names in _auto_install_hooks()** — edit to `src/cli/commands/add.py`
2. **Task 2: Smoke-test all three bug fixes end-to-end** — static grep verification (no file output)

## Files Created/Modified

- `src/cli/commands/add.py` — lines 99, 103, 104: four substitutions from `git_installed`/`claude_installed` to `git_hook`/`claude_hook`

## Verification Results

- `grep 'git_installed\|claude_installed' src/cli/commands/add.py` → **0 matches** (wrong keys gone)
- `grep '"git_hook"\|"claude_hook"' src/cli/commands/add.py` → **4 matches** (correct keys: 2 in if-condition, 2 in logger.info kwargs)
- `grep '"--async"' src/mcp_server/tools.py` → **0 matches** (Plan 01 Bug 1 still closed)
- `grep '\["graphiti"' src/mcp_server/context.py` → **0 matches** (Plan 01 Bug 2 still closed)

## Full Phase 8.2 Bug Summary

| Bug | File | Was | Now | Status |
|-----|------|-----|-----|--------|
| 1 | tools.py | `"--async"` (non-existent flag) | `"--quiet"` | CLOSED (R6.3) |
| 2 | context.py | `"graphiti"` (bare, PATH-dependent) | `_GRAPHITI_CLI` (venv-resolved) | CLOSED (R6.2) |
| 3 | add.py | `"git_installed"`, `"claude_installed"` (wrong keys) | `"git_hook"`, `"claude_hook"` | CLOSED (R4.2) |

## Decisions Made

- Four substitutions (not two): the `if` condition has two `.get()` calls AND the `logger.info` kwargs have two more — all four must be corrected for the log event to both trigger and log accurate data.
- Verified the fix against `src/hooks/manager.py` source — `results = {"git_hook": False, "claude_hook": False}` at line 130 confirms correctness.

## Deviations from Plan

None — plan executed exactly as written.

## Issues Encountered

None — all four substitutions were simple string replacements in a single block.

## Next Phase Readiness

- Phase 8.2 complete: all three bugs closed (R6.3, R6.2, R4.2)
- Ready for Phase 8.3 (queue dispatch gap closure)

---
*Phase: 08.2-gap-closure-mcp-server-bugs-inserted*
*Completed: 2026-02-24*

## Self-Check: PASSED

- FOUND: `src/cli/commands/add.py` — `git_hook`/`claude_hook` keys present; `git_installed`/`claude_installed` absent
- FOUND: `src/mcp_server/tools.py` — `"--quiet"` present, `"--async"` absent (Plan 01 fix retained)
- FOUND: `src/mcp_server/context.py` — `_GRAPHITI_CLI` in all three call sites (Plan 01 fix retained)
- All three requirements R6.3, R6.2, R4.2 declared CLOSED
