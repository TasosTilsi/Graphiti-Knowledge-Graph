---
phase: 08.2-gap-closure-mcp-server-bugs-inserted
plan: "01"
subsystem: mcp-server
tags: [bug-fix, mcp, capture, context, subprocess, gap-closure]

requires:
  - phase: 08-mcp-server
    provides: tools.py graphiti_capture() and context.py context resource

provides:
  - tools.py with --quiet replacing --async in graphiti_capture() Popen call
  - context.py using _GRAPHITI_CLI for all three subprocess call sites
  - R6.3 closed: MCP capture no longer silently fails
  - R6.2 closed: context injection works when venv is not on PATH

affects:
  - R6.3 (capture no longer fails silently with "no such option: --async")
  - R6.2 (context resource subprocess calls resolve the venv binary correctly)

tech-stack:
  added: []
  patterns:
    - venv-binary-resolution: _GRAPHITI_CLI = str(Path(sys.executable).parent / "graphiti")

key-files:
  modified:
    - src/mcp_server/tools.py
    - src/mcp_server/context.py

key-decisions:
  - "Replace --async with --quiet: capture command accepts --quiet (non-interactive suppression), not --async (which does not exist and caused immediate non-zero exit)"
  - "Import _GRAPHITI_CLI from tools.py into context.py: tools.py already has the correct venv-resolved path constant; re-using it avoids duplication and closes the PATH-dependency bug"

requirements-completed: [R6.3, R6.2]

duration: 5min
completed: 2026-02-24
---

# Phase 8.2 Plan 01: Fix --async Flag and context.py Bare Path

**Two MCP server subprocess bugs fixed: graphiti_capture() now uses --quiet; context.py now resolves the venv binary via _GRAPHITI_CLI instead of bare "graphiti"**

## Performance

- **Duration:** ~5 min
- **Started:** 2026-02-24
- **Completed:** 2026-02-24
- **Tasks:** 2 completed
- **Files modified:** 2

## Accomplishments

- Fixed `src/mcp_server/tools.py`: replaced `"--async"` with `"--quiet"` in the `subprocess.Popen` call inside `graphiti_capture()`. The `--async` flag does not exist in the `capture` command; it caused immediate non-zero exit silently.
- Fixed `src/mcp_server/context.py`: added `from src.mcp_server.tools import _GRAPHITI_CLI` import and replaced all three bare `"graphiti"` subprocess binary arguments with `_GRAPHITI_CLI`. The bare string fails when Claude Code's PATH does not include the virtualenv.

## Task Commits

1. **Task 1: Fix --async flag in graphiti_capture()** — edit to `src/mcp_server/tools.py`
2. **Task 2: Replace bare "graphiti" strings in context.py with _GRAPHITI_CLI** — edit to `src/mcp_server/context.py`

## Files Created/Modified

- `src/mcp_server/tools.py` — line 372: `"--async"` → `"--quiet"` in Popen args list; all other logic unchanged
- `src/mcp_server/context.py` — line 18: new import `from src.mcp_server.tools import _GRAPHITI_CLI`; lines 72, 87, 119: three subprocess binary args replaced with `_GRAPHITI_CLI`

## Verification Results

- `grep '"--async"' src/mcp_server/tools.py` → **0 matches** (bug closed)
- `grep '"--quiet"' src/mcp_server/tools.py` → **1 match** (fix present at line 372)
- `grep '\["graphiti"' src/mcp_server/context.py` → **0 matches** (bug closed)
- `grep '_GRAPHITI_CLI' src/mcp_server/context.py` → **4 matches** (1 import + 3 call sites)

## Decisions Made

- `--quiet` is the correct flag (suppresses Rich/console output; works in non-interactive mode). `--async` was never a valid option.
- Import `_GRAPHITI_CLI` from `tools.py` rather than re-defining the path in `context.py` — DRY, and tools.py already has the correct `str(Path(sys.executable).parent / "graphiti")` pattern.

## Deviations from Plan

None — plan executed exactly as written.

## Issues Encountered

None — both edits were straightforward string replacements at clearly identified line numbers.

## Next Phase Readiness

- Ready for Plan 8.2-02: Fix _auto_install_hooks() key names in add.py

---
*Phase: 08.2-gap-closure-mcp-server-bugs-inserted*
*Completed: 2026-02-24*

## Self-Check: PASSED

- FOUND: `src/mcp_server/tools.py` — `"--quiet"` present, `"--async"` absent
- FOUND: `src/mcp_server/context.py` — `_GRAPHITI_CLI` imported and used in all three subprocess call sites, zero bare `"graphiti"` subprocess args
