---
phase: 8.2-gap-closure-mcp-server-bugs-inserted
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mcp_server/tools.py
  - src/mcp_server/context.py
autonomous: true
gap_closure: true
requirements:
  - R6.3
  - R6.2

must_haves:
  truths:
    - "graphiti_capture() launches a background subprocess without --async and exits without error"
    - "context.py subprocess calls resolve the graphiti binary from the venv bin/ regardless of PATH"
    - "MCP server handles both capture and context resource calls correctly after changes"
  artifacts:
    - path: "src/mcp_server/tools.py"
      provides: "graphiti_capture() using --quiet instead of --async"
      contains: '"--quiet"'
    - path: "src/mcp_server/context.py"
      provides: "context resource using _GRAPHITI_CLI path constant"
      contains: "_GRAPHITI_CLI"
  key_links:
    - from: "src/mcp_server/context.py"
      to: "src/mcp_server/tools.py"
      via: "import _GRAPHITI_CLI"
      pattern: "from src\\.mcp_server\\.tools import _GRAPHITI_CLI"
    - from: "src/mcp_server/tools.py"
      to: "capture_command"
      via: "subprocess.Popen"
      pattern: "\"--quiet\""
---

<objective>
Fix two MCP server bugs that cause silent functional failures:
1. `graphiti_capture()` passes `--async` to the CLI, a flag that does not exist — the subprocess exits with a non-zero code immediately, silently. The correct flag for background/non-interactive mode is `--quiet`.
2. `context.py` uses the bare string `"graphiti"` in all subprocess calls. This fails when Claude Code's PATH does not include the virtualenv bin/ directory, which is the common case for MCP stdio servers. The fix is to import and use `_GRAPHITI_CLI` from `tools.py`, which already resolves the correct venv-relative path via `str(Path(sys.executable).parent / "graphiti")`.

Purpose: Close R6.3 (conversation capture no longer silently fails) and R6.2 (context injection works without venv on PATH).
Output: Two files corrected — tools.py and context.py — with verified subprocess calls using the correct flag and resolved binary path.
</objective>

<execution_context>
@/home/tasostilsi/.claude/get-shit-done/workflows/execute-plan.md
@/home/tasostilsi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix --async flag in graphiti_capture()</name>
  <files>src/mcp_server/tools.py</files>
  <action>
In `src/mcp_server/tools.py`, find the `graphiti_capture()` function (line 348). The `subprocess.Popen` call on line 372 passes `"--async"` as a CLI argument. The `capture_command` in `src/cli/commands/capture.py` accepts no `--async` flag — it accepts `--auto`, `--transcript-path`, `--session-id`, `--format`, and `--quiet`. The intent of the MCP call is fire-and-forget background capture, so `--quiet` is the correct replacement (suppresses output, works in non-interactive mode without extra required args).

Change exactly this line:
```python
# BEFORE (line 372, inside subprocess.Popen):
[_GRAPHITI_CLI, "capture", "--async"],
# AFTER:
[_GRAPHITI_CLI, "capture", "--quiet"],
```

No other changes to this file. The rest of graphiti_capture() — Popen with DEVNULL, start_new_session=True, FileNotFoundError handling — is correct and must not be touched.
  </action>
  <verify>
Run from the project root:
```
grep -n '\-\-async\|\-\-quiet' src/mcp_server/tools.py
```
Expected: One line containing `"--quiet"`, zero lines containing `"--async"`.

Also confirm the function signature and Popen structure are intact:
```
grep -n 'graphiti_capture\|subprocess.Popen\|start_new_session' src/mcp_server/tools.py
```
  </verify>
  <done>
`src/mcp_server/tools.py` contains `"--quiet"` at the Popen call site and zero occurrences of `"--async"`. The function otherwise unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace bare "graphiti" strings in context.py with _GRAPHITI_CLI</name>
  <files>src/mcp_server/context.py</files>
  <action>
`src/mcp_server/context.py` has three subprocess calls that use the bare string `"graphiti"`:

1. Line 70: `["graphiti", "index"]` inside `_trigger_background_reindex()`
2. Line 84: `["graphiti", "config", "get", "mcp.context_tokens"]` inside `_get_token_budget()`
3. Line 117: `["graphiti", "search", "decisions architecture patterns", "--limit", "20", "--format", "json"]` inside `get_context()`

All three must be changed to use the resolved binary path from `tools.py`.

**Step 1 — Add the import.** After the existing `from pathlib import Path` import block at the top, add:
```python
from src.mcp_server.tools import _GRAPHITI_CLI
```
Place it after the stdlib imports and before the `logging.basicConfig(...)` call (i.e., after line 16 `from pathlib import Path`).

**Step 2 — Replace all three occurrences** of `"graphiti"` (as the first list element in subprocess call argument lists) with `_GRAPHITI_CLI`:

Change 1 — `_trigger_background_reindex()`:
```python
# BEFORE:
subprocess.Popen(
    ["graphiti", "index"],
# AFTER:
subprocess.Popen(
    [_GRAPHITI_CLI, "index"],
```

Change 2 — `_get_token_budget()`:
```python
# BEFORE:
result = subprocess.run(
    ["graphiti", "config", "get", "mcp.context_tokens"],
# AFTER:
result = subprocess.run(
    [_GRAPHITI_CLI, "config", "get", "mcp.context_tokens"],
```

Change 3 — `get_context()`:
```python
# BEFORE:
result = subprocess.run(
    ["graphiti", "search", "decisions architecture patterns", "--limit", "20", "--format", "json"],
# AFTER:
result = subprocess.run(
    [_GRAPHITI_CLI, "search", "decisions architecture patterns", "--limit", "20", "--format", "json"],
```

No other logic changes. The `sys` import is already present (line 15); no additional stdlib imports needed. The `_GRAPHITI_CLI` constant in `tools.py` is a module-level string (`str(Path(sys.executable).parent / "graphiti")`), so importing it is safe and has no side effects.
  </action>
  <verify>
Confirm the import is present:
```
grep -n '_GRAPHITI_CLI\|from src.mcp_server' src/mcp_server/context.py
```
Expected: At least 4 lines — one import line and three usage lines.

Confirm no bare `"graphiti"` remains as the first subprocess argument:
```
grep -n '"graphiti"' src/mcp_server/context.py
```
Expected: zero results.

Confirm the module is importable (no circular import or syntax error):
```
.venv/bin/python -c "from src.mcp_server import context; print('ok')"
```
Expected output: `ok`
  </verify>
  <done>
`src/mcp_server/context.py` imports `_GRAPHITI_CLI` from `src.mcp_server.tools` and uses it in all three subprocess call sites. Zero bare `"graphiti"` strings remain as subprocess binary arguments. Module imports without error.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, run the following checks from the project root:

1. No `--async` flag anywhere in the MCP server package:
   ```
   grep -rn '\-\-async' src/mcp_server/
   ```
   Expected: zero results.

2. No bare `"graphiti"` as subprocess binary in context.py:
   ```
   grep -n '"graphiti"' src/mcp_server/context.py
   ```
   Expected: zero results.

3. Both modules import cleanly:
   ```
   .venv/bin/python -c "from src.mcp_server import tools, context; print('ok')"
   ```
   Expected: `ok`

4. _GRAPHITI_CLI resolves to a real file:
   ```
   .venv/bin/python -c "from src.mcp_server.tools import _GRAPHITI_CLI; import os; print(os.path.exists(_GRAPHITI_CLI), _GRAPHITI_CLI)"
   ```
   Expected: `True /home/tasostilsi/Development/Projects/graphiti-knowledge-graph/.venv/bin/graphiti` (or equivalent venv path).
</verification>

<success_criteria>
- `graphiti_capture()` launches `graphiti capture --quiet` (not `--async`) via Popen — subprocess will exit 0 instead of immediately exiting with "no such option"
- All three `subprocess` calls in `context.py` use `_GRAPHITI_CLI` (venv-resolved path) instead of bare `"graphiti"`
- Both files import without errors in the venv Python
- R6.3 functional bug closed: MCP capture no longer silently fails on launch
- R6.2 path bug closed: context injection works when venv is not on PATH
</success_criteria>

<output>
After completion, create `.planning/phases/8.2-gap-closure-mcp-server-bugs-inserted/8.2-01-SUMMARY.md` following the GSD summary template.
</output>
