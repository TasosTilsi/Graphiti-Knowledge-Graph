---
phase: 08-mcp-server
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/mcp_server/__init__.py
  - src/mcp_server/toon_utils.py
autonomous: true
requirements:
  - R6.2
  - R6.3

must_haves:
  truths:
    - "SKILL.md exists at ~/.claude/skills/graphiti/SKILL.md (installed by graphiti mcp install)"
    - "mcp and python-toon dependencies are declared in pyproject.toml"
    - "src/mcp_server/ package is importable with __init__.py"
    - "TOON encoding utility wraps python-toon with safe fallback for non-array responses"
  artifacts:
    - path: "pyproject.toml"
      provides: "mcp and python-toon dependency declarations"
      contains: "mcp[cli]>=1.26.0,<2.0.0"
    - path: "src/mcp_server/__init__.py"
      provides: "MCP server package exports"
      min_lines: 5
    - path: "src/mcp_server/toon_utils.py"
      provides: "TOON encoding with array-size guard and token budget trimming"
      exports: ["encode_response", "trim_to_token_budget"]
  key_links:
    - from: "src/mcp_server/toon_utils.py"
      to: "python-toon"
      via: "from toon import encode"
      pattern: "from toon import encode"
    - from: "src/mcp_server/toon_utils.py"
      to: "trim_to_token_budget"
      via: "4 chars/token approximation, header-preserving TOON row trimming"
      pattern: "char_budget = token_budget \\* 4"
---

<objective>
Lay the dependency and package foundation for the Phase 8 MCP server. This plan installs the required libraries into pyproject.toml, creates the src/mcp_server/ package, and implements the TOON encoding utility that all other MCP plans depend on.

Purpose: Without the mcp and python-toon dependencies, no MCP server code can be imported or tested. The TOON utility (with its array-size guard and token-budget trimming) is a shared primitive used by both tools.py and context.py in later plans.

Output:
- pyproject.toml updated with mcp[cli]>=1.26.0,<2.0.0 and python-toon>=0.1.3
- src/mcp_server/ package scaffolded
- src/mcp_server/toon_utils.py with encode_response() and trim_to_token_budget()
- SKILL.md content embedded (written to disk during graphiti mcp install in Plan 03)
</objective>

<execution_context>
@/home/tasostilsi/.claude/get-shit-done/workflows/execute-plan.md
@/home/tasostilsi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-mcp-server/08-CONTEXT.md
@.planning/phases/08-mcp-server/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mcp and python-toon to pyproject.toml dependencies</name>
  <files>pyproject.toml</files>
  <action>
Add two new dependencies to the `[project] dependencies` list in pyproject.toml:
- `"mcp[cli]>=1.26.0,<2.0.0"` — Official Anthropic MCP Python SDK with FastMCP. The upper bound `<2.0.0` pins to the stable 1.x branch because MCP v2 is planned for Q1 2026 and may break the API.
- `"python-toon>=0.1.3"` — TOON encoding library. Note: the PyPI package is `python-toon` but it imports as `toon`.

After editing pyproject.toml, run `pip install -e ".[dev]"` to install the new dependencies into the active venv. Verify with `python -c "from mcp.server.fastmcp import FastMCP; from toon import encode; print('OK')"`.

Do NOT add tiktoken — character-count approximation (4 chars/token) is sufficient per research.
  </action>
  <verify>
Run: `python -c "from mcp.server.fastmcp import FastMCP; from toon import encode; print('imports OK')"` — must print "imports OK" with no errors.

Also verify pyproject.toml contains both entries: `grep "mcp\[cli\]" pyproject.toml && grep "python-toon" pyproject.toml`
  </verify>
  <done>Both imports succeed. pyproject.toml contains mcp[cli]>=1.26.0,<2.0.0 and python-toon>=0.1.3.</done>
</task>

<task type="auto">
  <name>Task 2: Create src/mcp_server/ package with TOON utility module</name>
  <files>
    src/mcp_server/__init__.py
    src/mcp_server/toon_utils.py
  </files>
  <action>
Create the `src/mcp_server/` package directory with two files:

**src/mcp_server/__init__.py** — minimal package init with a comment describing the module:
```python
"""MCP server for graphiti knowledge graph.

Exposes all CLI commands as MCP tools (graphiti_ prefix) and provides a
graphiti://context resource for session-start context injection.

Modules:
    server.py   — FastMCP app, tool registrations, resource, transport entry point
    tools.py    — Subprocess-based tool handler functions (CLI wrappers)
    context.py  — graphiti://context resource (stale detection, query, TOON encode)
    install.py  — graphiti mcp install command (writes ~/.claude.json)
    toon_utils.py — TOON encoding utilities with array-size guard and token budget
"""
```

**src/mcp_server/toon_utils.py** — TOON encoding utilities. Implement two functions:

`encode_response(data: list[dict] | dict | str) -> str`:
- If data is a list with 3+ items: use `toon.encode(data)` for ~40% token savings
- If data is a list with <3 items OR a single dict OR a string: return `json.dumps(data, indent=2)` — TOON header overhead exceeds savings for tiny responses
- The threshold of 3 items is per the research finding in 08-RESEARCH.md (Pitfall 6)

`trim_to_token_budget(text: str, token_budget: int) -> str`:
- Use 4 chars per token approximation: `char_budget = token_budget * 4`
- If len(text) <= char_budget: return text unchanged
- Split text on newlines. Identify TOON header lines (lines starting with `[` or containing `{`) — preserve these always.
- Remove data rows from the front (oldest first) until within budget.
- Update the TOON header count: regex-replace `\[(\d+),\]` with the new row count after trimming. If `[,]` (no count) leave as-is.
- Return trimmed text.

Include `import json`, `import re` and `from toon import encode` at the top. Add a `__all__ = ["encode_response", "trim_to_token_budget"]` export list.

All logging in this module must go to stderr only — never stdout — because stdio transport uses stdout for JSON-RPC. Use `import sys; print(..., file=sys.stderr)` if needed, or just omit logging (these are pure encoding functions).

Do NOT import Rich console or structlog in this module.
  </action>
  <verify>
Run: `python -c "from src.mcp_server.toon_utils import encode_response, trim_to_token_budget; data = [{'id': '1', 'name': 'a'}, {'id': '2', 'name': 'b'}, {'id': '3', 'name': 'c'}]; result = encode_response(data); assert result.startswith('['), f'Expected TOON, got: {result[:50]}'; print('TOON OK')"` — must print "TOON OK".

Run: `python -c "from src.mcp_server.toon_utils import encode_response; result = encode_response({'id': '1', 'name': 'single'}); import json; json.loads(result); print('single dict OK')"` — must print "single dict OK" (returns JSON, not TOON).

Run: `python -c "from src.mcp_server.toon_utils import trim_to_token_budget; long_text = '\n'.join(['[5,]{id}:', '1', '2', '3', '4', '5']); trimmed = trim_to_token_budget(long_text, 1); assert len(trimmed) <= 10, f'too long: {len(trimmed)}'; print('trim OK')"` — must print "trim OK".
  </verify>
  <done>
src/mcp_server/ package exists and imports cleanly. encode_response() returns TOON for 3+ item lists and JSON for smaller/scalar responses. trim_to_token_budget() preserves TOON headers and trims oldest rows first. No stdout writes in the module.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `pip show mcp python-toon` — both packages listed with correct versions
2. `python -c "from src.mcp_server import toon_utils; print(toon_utils.__all__)"` — prints ['encode_response', 'trim_to_token_budget']
3. `grep "mcp\[cli\]" pyproject.toml` — shows the pinned version range
4. No Rich imports or structlog imports in src/mcp_server/toon_utils.py (would contaminate stdio)
</verification>

<success_criteria>
- mcp and python-toon installed in venv and importable
- src/mcp_server/ package exists with __init__.py
- encode_response() correctly applies 3-item threshold (TOON for arrays, JSON for scalars)
- trim_to_token_budget() uses 4-char/token approximation, preserves TOON header, trims oldest rows
- pyproject.toml reflects the new dependencies for reproducible installs
</success_criteria>

<output>
After completion, create `.planning/phases/08-mcp-server/08-01-SUMMARY.md` with:
- What was built (files created/modified)
- Key implementation decisions made (TOON threshold, trim strategy)
- Verification commands run and their output
- Any deviations from the plan
</output>
