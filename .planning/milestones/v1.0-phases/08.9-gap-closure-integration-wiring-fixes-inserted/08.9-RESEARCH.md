# Phase 8.9: Gap Closure — Integration Wiring Fixes - Research

**Researched:** 2026-03-01
**Domain:** Python subprocess wiring, MCP tool registration, JSON dict traversal, CLI subcommand syntax
**Confidence:** HIGH

## Summary

Phase 8.9 fixes three distinct integration bugs in `src/mcp_server/tools.py`, `src/mcp_server/server.py`, and `src/hooks/manager.py`. All bugs are mechanical — wrong flag syntax, missing function, wrong dict key traversal. No architectural changes are required. The fixes are self-contained and can be verified by reading the current code against the actual CLI interface and the real settings.json structure.

Bug 1 (graphiti_index missing) is HIGH severity — MCP users currently cannot trigger git history indexing from Claude Code at all. Bug 2 (hooks.enabled CLI syntax) is MEDIUM — the wrong flags (`--get`/`--set`) always fail silently, defaulting to `True` regardless of what the user sets. Bug 3 (_is_claude_hook_installed dict depth) is LOW severity — cosmetic display issue in `graphiti hooks status`, but logic in installer.py that reads hooks is correct (installer checks `entry.get("hooks", [])` correctly; only manager.py's check function uses the wrong depth).

**Primary recommendation:** Three targeted edits to two files. No new dependencies, no API changes.

<phase_requirements>
## Phase Requirements

| ID | Description | Research Support |
|----|-------------|-----------------|
| R6.1 | MCP Server Tools — MCP tools wrapping CLI operations | Bug 1: add graphiti_index tool handler in tools.py and register in server.py using existing _run_graphiti() helper and mcp.tool() pattern |
| R3.3 | Pre-Commit Validation — audit log of sanitization events, hooks.enabled config | Bug 2: fix get_hooks_enabled() and set_hooks_enabled() in manager.py to use `graphiti config get hooks.enabled` / `graphiti config set hooks.enabled <value>` subcommand syntax |
| R4.1 | Conversation-Based Capture — automatic capture; hooks status display | Bug 3: fix _is_claude_hook_installed() dict traversal to check `entry["hooks"][0]["command"]` matching the actual .claude/settings.json structure |
</phase_requirements>

---

## Bug 1: graphiti_index MCP Tool Missing

### Current State (tools.py)

`src/mcp_server/tools.py` exports 10 tools:
```python
__all__ = [
    "graphiti_add", "graphiti_search", "graphiti_list", "graphiti_show",
    "graphiti_delete", "graphiti_summarize", "graphiti_compact",
    "graphiti_capture", "graphiti_health", "graphiti_config",
]
```

No `graphiti_index` function exists.

### Current State (server.py)

`src/mcp_server/server.py` registers exactly those 10 tools:
```python
from src.mcp_server.tools import (
    graphiti_add, graphiti_search, graphiti_list, graphiti_show,
    graphiti_delete, graphiti_summarize, graphiti_compact,
    graphiti_capture, graphiti_health, graphiti_config,
)
# ...
mcp.tool()(graphiti_add)
# ... (10 mcp.tool() calls)
```

### CLI Interface to Wrap

The `graphiti index` command (in `src/cli/commands/index.py`) accepts:
- `--full` (bool) — wipe and re-index from scratch
- `--since <date_or_sha>` (optional str) — index commits since date or SHA
- `--verbose`/`-v` (bool) — show per-commit progress

### Fix Pattern

All tools use `_run_graphiti(args, timeout, cwd=_get_cwd())`. The new tool should:
1. Build CLI args: `["index"]` + optional flags
2. Call `_run_graphiti(cmd, timeout=300, cwd=_get_cwd())` — 300s timeout because indexing large repos can take minutes
3. Return stdout on success, raise RuntimeError on non-zero returncode
4. Add to `__all__`

### server.py Registration Pattern

```python
# Import
from src.mcp_server.tools import (
    ...,
    graphiti_index,
)
# Register
mcp.tool()(graphiti_index)
```

The comment "Register all 10 CLI tools" will need updating to "11".

---

## Bug 2: hooks.enabled CLI Flag Syntax Wrong

### Current Wrong Code (manager.py lines 38-43 and 64-71)

```python
# get_hooks_enabled() — WRONG
result = subprocess.run(
    [_GRAPHITI_CLI, "config", "--get", "hooks.enabled"],  # --get is WRONG flag
    ...
)

# set_hooks_enabled() — WRONG
result = subprocess.run(
    [_GRAPHITI_CLI, "config", "--set", f"hooks.enabled={str(enabled).lower()}"],  # WRONG
    ...
)
```

### Correct Syntax

The `graphiti config` command uses subcommand syntax (verified from `src/mcp_server/tools.py` graphiti_config function):
```python
# From tools.py:
if value:
    cmd = ["config", "set", key, value]     # "graphiti config set hooks.enabled true"
else:
    cmd = ["config", "get", key]             # "graphiti config get hooks.enabled"
```

Also confirmed in `src/cli/commands/config.py` (the actual CLI handler).

### Fix

**get_hooks_enabled()**: Change `["--get", "hooks.enabled"]` to `["config", "get", "hooks.enabled"]`

**set_hooks_enabled()**: Change `["--set", f"hooks.enabled={str(enabled).lower()}"]` to `["config", "set", "hooks.enabled", str(enabled).lower()]`

---

## Bug 3: _is_claude_hook_installed() Wrong Dict Depth

### Actual .claude/settings.json Structure

The actual settings.json (confirmed from project file at `.claude/settings.json`):
```json
{
  "hooks": {
    "Stop": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); ...",
            "async": true,
            "timeout": 120
          }
        ]
      }
    ]
  }
}
```

Each entry in `hooks["Stop"]` is an object with:
- `"matcher"`: string
- `"hooks"`: array of hook objects, each with `"command"`, `"type"`, `"async"`, `"timeout"`

### Current Wrong Code (manager.py lines 107-109)

```python
for hook in settings["hooks"]["Stop"]:
    if isinstance(hook, dict) and "graphiti capture" in hook.get("command", ""):
        return True
```

This looks for `hook.get("command", "")` at the top-level entry dict. But top-level entries do NOT have a `"command"` key — they have a nested `"hooks"` array.

### Correct Fix

```python
for entry in settings["hooks"]["Stop"]:
    if isinstance(entry, dict):
        for h in entry.get("hooks", []):
            if isinstance(h, dict) and "graphiti capture" in h.get("command", ""):
                return True
```

This matches the pattern already used correctly in `install_claude_hook()` in `installer.py` (lines 265-271):
```python
for entry in settings["hooks"]["Stop"]:
    if isinstance(entry, dict):
        for h in entry.get("hooks", []):
            if "graphiti capture" in h.get("command", ""):
                return False  # (already installed)
```

The fix simply brings `_is_claude_hook_installed()` in manager.py into alignment with the pattern in installer.py.

---

## Architecture Patterns

### MCP Tool Registration (HIGH confidence)

All tools follow the exact same pattern:
1. Plain Python function with docstring
2. Uses `_run_graphiti()` helper with appropriate timeout
3. Returns string (stdout, or formatted/encoded result)
4. Raises `RuntimeError` on failure
5. Added to `__all__` in tools.py
6. Imported and registered with `mcp.tool()(fn)` in server.py

### Logging in MCP Server Files (CRITICAL from CLAUDE.md)

- `src/mcp_server/tools.py` uses standard `logging` (not structlog)
- Never print to stdout — use `logger.warning(...)` only
- `src/hooks/manager.py` uses structlog (correct, it's not in mcp_server/)

### Timeout Selection for graphiti_index

| Tool | Timeout | Reason |
|------|---------|--------|
| graphiti_search | 30s | Query only |
| graphiti_compact | 120s | LLM-assisted dedup |
| graphiti_capture | fire-and-forget (Popen) | Async |
| graphiti_index (new) | 300s | Entire git history can take minutes |

---

## Code Examples

### New graphiti_index Tool (tools.py)

```python
def graphiti_index(
    full: bool = False,
    since: str = "",
) -> str:
    """Index git history into the knowledge graph.

    Incremental by default — only processes commits not yet indexed.
    Use full=True to wipe and re-index entire history.

    Args:
        full: If True, wipe all git-indexed knowledge and re-index from scratch.
        since: Index commits since date (YYYY-MM-DD) or commit SHA (optional).

    Returns:
        Status message from the CLI (commits processed, entities created, etc.).

    Raises:
        RuntimeError: If the graphiti CLI returns a non-zero exit code.
    """
    cmd = ["index"]
    if full:
        cmd.append("--full")
    if since:
        cmd.extend(["--since", since])

    returncode, stdout, stderr = _run_graphiti(cmd, timeout=300, cwd=_get_cwd())

    if returncode != 0:
        raise RuntimeError(f"graphiti index failed: {stderr.strip()}")

    return stdout.strip() or "Git history indexed successfully."
```

### Fixed get_hooks_enabled() (manager.py)

```python
result = subprocess.run(
    [_GRAPHITI_CLI, "config", "get", "hooks.enabled"],
    capture_output=True,
    text=True,
    timeout=5
)
```

### Fixed set_hooks_enabled() (manager.py)

```python
result = subprocess.run(
    [_GRAPHITI_CLI, "config", "set", "hooks.enabled", str(enabled).lower()],
    capture_output=True,
    text=True,
    timeout=5
)
```

### Fixed _is_claude_hook_installed() (manager.py)

```python
for entry in settings["hooks"]["Stop"]:
    if isinstance(entry, dict):
        for h in entry.get("hooks", []):
            if isinstance(h, dict) and "graphiti capture" in h.get("command", ""):
                return True
```

---

## Common Pitfalls

### Pitfall 1: Timeout Too Short for graphiti_index
**What goes wrong:** Tool times out for repos with many commits
**How to avoid:** Use 300s (5 minutes). Document in docstring.

### Pitfall 2: Adding verbose Flag to MCP Tool
**What goes wrong:** `--verbose` makes sense for CLI but not MCP — MCP callers don't see stdout progress
**How to avoid:** Do not expose `--verbose` in the MCP tool. Return final result only.

### Pitfall 3: Using structlog in MCP Server Module
**What goes wrong:** structlog may write to stdout, corrupting JSON-RPC protocol
**How to avoid:** `tools.py` already uses `logging.basicConfig(stream=sys.stderr)`. Keep using `logger.warning()`.

---

## Sources

### Primary (HIGH confidence)
- Direct code inspection: `src/mcp_server/tools.py` — existing tool pattern and `__all__`
- Direct code inspection: `src/mcp_server/server.py` — registration pattern, 10 current tools
- Direct code inspection: `src/hooks/manager.py` — bugs at lines 39, 67, 108
- Direct code inspection: `.claude/settings.json` — actual JSON structure (nested hooks array)
- Direct code inspection: `src/hooks/installer.py` lines 265-271 — correct traversal pattern
- Direct code inspection: `src/cli/commands/index.py` — CLI flags available for wrapping

## Open Questions

1. **Should graphiti_index return structured JSON or plain text?**
   - Recommendation: Return stdout.strip() as plain text — consistent with graphiti_compact pattern.

2. **Should we expose `--since` for graphiti_index via MCP?**
   - Recommendation: Yes, expose it as optional string parameter with empty default.

## Metadata

**Confidence breakdown:**
- Bug locations: HIGH — code inspected directly, line numbers confirmed
- Fix correctness: HIGH — cross-referenced with correct patterns in same codebase
- New tool design: HIGH — follows identical pattern to all other 10 tools

**Research date:** 2026-03-01
**Valid until:** Until code changes (stable — these are targeted bug fixes)
