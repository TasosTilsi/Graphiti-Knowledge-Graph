---
id: 8.9-02
wave: 1
depends_on: []
files_modified:
  - src/hooks/manager.py
autonomous: true
requirements:
  - R3.3
  - R4.1
---

# Plan 8.9-02: Fix hooks.enabled CLI Syntax and _is_claude_hook_installed() Traversal

## Objective

Fix two bugs in `src/hooks/manager.py`:
1. `get_hooks_enabled()` and `set_hooks_enabled()` use wrong CLI flag syntax (`--get`/`--set`) which silently fails; the config subcommand syntax is `graphiti config get <key>` / `graphiti config set <key> <value>`
2. `_is_claude_hook_installed()` traverses the settings.json dict at the wrong depth — it checks `hook.get("command")` at the top-level entry but the actual structure nests commands inside `entry["hooks"][0]["command"]`

Both bugs run in Wave 1 (parallel with Plan 8.9-01 since they touch different files).

## Context

@src/hooks/manager.py
@src/hooks/installer.py
@.claude/settings.json
@.planning/phases/08.9-gap-closure-integration-wiring-fixes-inserted/08.9-RESEARCH.md

## Background

### Bug 2 — CLI Syntax

The correct syntax is confirmed by inspecting `src/mcp_server/tools.py` `graphiti_config()`:
```python
if value:
    cmd = ["config", "set", key, value]
else:
    cmd = ["config", "get", key]
```

Current wrong code in `manager.py`:
- `get_hooks_enabled()`: `[_GRAPHITI_CLI, "config", "--get", "hooks.enabled"]` — `--get` is not a valid flag
- `set_hooks_enabled()`: `[_GRAPHITI_CLI, "config", "--set", f"hooks.enabled={str(enabled).lower()}"]` — `--set` is not a valid flag and the key=value format is wrong

The `returncode != 0` branch in `get_hooks_enabled()` currently returns `True` (default) even when the config is NOT set to true — because the wrong flag causes a non-zero exit, and the else branch always returns `True`. This means `set_hooks_enabled(False)` writes nothing and `get_hooks_enabled()` always returns `True`.

### Bug 3 — Dict Traversal Depth

The actual `.claude/settings.json` structure:
```json
{
  "hooks": {
    "Stop": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); ...graphiti capture...",
            "async": true,
            "timeout": 120
          }
        ]
      }
    ]
  }
}
```

Current wrong code in `_is_claude_hook_installed()`:
```python
for hook in settings["hooks"]["Stop"]:
    if isinstance(hook, dict) and "graphiti capture" in hook.get("command", ""):
        return True
```

`hook` here is the top-level entry (which has keys `"matcher"` and `"hooks"`, NOT `"command"`). `hook.get("command", "")` always returns `""`.

The correct pattern (already used in `installer.py` for idempotent install detection):
```python
for entry in settings["hooks"]["Stop"]:
    if isinstance(entry, dict):
        for h in entry.get("hooks", []):
            if "graphiti capture" in h.get("command", ""):
                ...
```

## Tasks

<task id="1" type="auto">
  <title>Fix get_hooks_enabled() and set_hooks_enabled() CLI flag syntax</title>
  <files>
    - src/hooks/manager.py
  </files>
  <action>
    In `src/hooks/manager.py`, fix both functions:

    **Fix get_hooks_enabled() (lines ~38-56):**

    Change the subprocess.run call from:
    ```python
    result = subprocess.run(
        [_GRAPHITI_CLI, "config", "--get", "hooks.enabled"],
        capture_output=True,
        text=True,
        timeout=5
    )
    ```

    To:
    ```python
    result = subprocess.run(
        [_GRAPHITI_CLI, "config", "get", "hooks.enabled"],
        capture_output=True,
        text=True,
        timeout=5
    )
    ```

    Also fix the logic after the call. Currently:
    ```python
    if result.returncode == 0 and "true" in result.stdout.lower():
        return True
    else:
        # Config key doesn't exist or is not set - default to enabled
        return True
    ```

    This always returns True. Fix to actually read the value:
    ```python
    if result.returncode == 0:
        # Config key found — parse the value
        output = result.stdout.strip().lower()
        if output == "false":
            return False
        # "true", "1", "yes", or any non-false output = enabled
        return True
    else:
        # Config key doesn't exist or graphiti unavailable — default to enabled
        # (hooks are installed intentionally, so enabled by default)
        return True
    ```

    **Fix set_hooks_enabled() (lines ~59-82):**

    Change the subprocess.run call from:
    ```python
    result = subprocess.run(
        [_GRAPHITI_CLI, "config", "--set", f"hooks.enabled={str(enabled).lower()}"],
        capture_output=True,
        text=True,
        timeout=5
    )
    ```

    To:
    ```python
    result = subprocess.run(
        [_GRAPHITI_CLI, "config", "set", "hooks.enabled", str(enabled).lower()],
        capture_output=True,
        text=True,
        timeout=5
    )
    ```

    Keep the existing returncode check and logging below it unchanged.
  </action>
  <verify>
    <automated>cd /home/tasostilsi/Development/Projects/graphiti-knowledge-graph && python -c "
import inspect
from src.hooks import manager
src = inspect.getsource(manager.get_hooks_enabled)
assert '--get' not in src, 'Still using wrong --get flag'
assert 'config\", \"get\"' in src or \"config', 'get'\" in src, 'Missing correct config get subcommand'
src2 = inspect.getsource(manager.set_hooks_enabled)
assert '--set' not in src2, 'Still using wrong --set flag'
assert 'config\", \"set\"' in src2 or \"config', 'set'\" in src2, 'Missing correct config set subcommand'
print('hooks.enabled CLI syntax OK')
"</automated>
  </verify>
  <done>
    - `get_hooks_enabled()` calls `[_GRAPHITI_CLI, "config", "get", "hooks.enabled"]`
    - `set_hooks_enabled()` calls `[_GRAPHITI_CLI, "config", "set", "hooks.enabled", str(enabled).lower()]`
    - `get_hooks_enabled()` returns `False` when output is "false", `True` otherwise
    - No `--get` or `--set` flag strings remain in the function bodies
  </done>
</task>

<task id="2" type="auto">
  <title>Fix _is_claude_hook_installed() dict traversal depth</title>
  <files>
    - src/hooks/manager.py
  </files>
  <action>
    In `src/hooks/manager.py`, fix the `_is_claude_hook_installed()` function.

    Find the loop at the end of the try block (after the `if "hooks" not in settings` guard) that currently reads:

    ```python
    # Check if any Stop hook contains graphiti capture command
    for hook in settings["hooks"]["Stop"]:
        if isinstance(hook, dict) and "graphiti capture" in hook.get("command", ""):
            return True

    return False
    ```

    Replace it with the correct two-level traversal (matching the pattern in `installer.py`):

    ```python
    # Check if any Stop hook entry contains graphiti capture command
    # Settings structure: hooks.Stop = [{ matcher, hooks: [{type, command, ...}] }]
    for entry in settings["hooks"]["Stop"]:
        if isinstance(entry, dict):
            for h in entry.get("hooks", []):
                if isinstance(h, dict) and "graphiti capture" in h.get("command", ""):
                    return True

    return False
    ```

    Also update the variable name in the loop header from `hook` to `entry` and the inner loop variable from nothing to `h` to avoid confusion between the outer entry and the inner hook object.

    Do NOT change any other part of the function (the settings_path check, the file reading, the `"hooks" not in settings` guard, or the exception handler).
  </action>
  <verify>
    <automated>cd /home/tasostilsi/Development/Projects/graphiti-knowledge-graph && python -c "
import json
import tempfile
from pathlib import Path
from unittest.mock import patch

# Simulate real .claude/settings.json structure
settings = {
    'hooks': {
        'Stop': [
            {
                'matcher': '',
                'hooks': [
                    {
                        'type': 'command',
                        'command': 'graphiti capture --auto',
                        'async': True,
                        'timeout': 120
                    }
                ]
            }
        ]
    }
}

# Write to a temp file
with tempfile.TemporaryDirectory() as tmpdir:
    project_path = Path(tmpdir)
    claude_dir = project_path / '.claude'
    claude_dir.mkdir()
    settings_path = claude_dir / 'settings.json'
    settings_path.write_text(json.dumps(settings))

    from src.hooks.manager import _is_claude_hook_installed
    result = _is_claude_hook_installed(project_path)
    assert result is True, f'Expected True, got {result}'
    print('_is_claude_hook_installed() correctly detects hook at nested depth OK')
"</automated>
  </verify>
  <done>
    - `_is_claude_hook_installed()` traverses `entry.get("hooks", [])` for each entry in Stop array
    - Function returns `True` when `.claude/settings.json` contains a nested hook with "graphiti capture"
    - Function returns `False` when settings.json has no hook or has the old flat structure
    - No `.get("command", "")` call on the top-level entry object remains
  </done>
</task>

## Verification Criteria

Run both automated tests above. Additionally, inspect the file to confirm no `--get` or `--set` flags remain and the correct two-level traversal is in place:

```bash
cd /home/tasostilsi/Development/Projects/graphiti-knowledge-graph
grep -n "\-\-get\|\-\-set" src/hooks/manager.py && echo "FAIL: wrong flags still present" || echo "PASS: no wrong flags"
grep -n "hook\.get(\"command\")" src/hooks/manager.py && echo "FAIL: wrong dict depth still present" || echo "PASS: no wrong dict depth"
```

## Must-Haves

- `get_hooks_enabled()` calls `graphiti config get hooks.enabled` — satisfies R3.3 (hooks.enabled readable)
- `set_hooks_enabled(False)` calls `graphiti config set hooks.enabled false` — satisfies R3.3 (hooks.enabled writable)
- `get_hooks_enabled()` returns `False` when config says "false" (not always True) — satisfies R3.3 correctness
- `_is_claude_hook_installed()` returns `True` for the actual `.claude/settings.json` nested structure — satisfies R4.1 (hooks status display)
- No `--get` or `--set` flags in subprocess calls
- Uses structlog (correct — manager.py is NOT in mcp_server/)
