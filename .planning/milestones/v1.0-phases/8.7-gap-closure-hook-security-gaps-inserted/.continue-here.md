---
phase: 8.7-gap-closure-hook-security-gaps-inserted
task: 0
total_tasks: 3
status: pending
last_updated: 2026-02-27T08:32:32.584Z
---

<current_state>
Phase 8.7 is fully planned with 3 PLAN.md files ready to execute. No code has been
changed yet — this is a clean starting point for execution.

Committed as f728ade (plan(8.7): gap closure — hook security gaps (3 plans))
</current_state>

<completed_work>

- Phase 8.7 gap plan created — 3 PLAN.md files in this directory
- ROADMAP.md updated: Phase 8.7 inserted between 8.6 and 9
- Phase 8.5 ROADMAP checkboxes corrected (were unchecked despite complete SUMMARYs)
- STATE.md updated to reflect Phase 8.7 as current

Background context (what triggered this phase):
- Wrote scripts/verify_phase_07.py and scripts/verify_phase_71.py (commit 79dfecf)
- Verification revealed 2 bugs:
  1. scan_staged_secrets() silently skips newly staged files (not in HEAD)
  2. graphiti hooks install deploys 4 hooks, not 5 (pre-commit missing)

</completed_work>

<remaining_work>

- Task 1 (Plan 8.7-01): Fix `scan_staged_secrets()` in src/gitops/hooks.py
  - Change line 62: `if diff_item.deleted_file:` → `if diff_item.new_file:`
  - Update comment: "Skip deleted files" → "Skip files staged for deletion (a_blob=None)"
  - Run pytest to verify no regressions

- Task 2 (Plan 8.7-02): Wire `install_precommit_hook()` into CLI
  - src/cli/commands/hooks.py: add precommit to install_command(), uninstall_command(), status_command()
  - Add imports for install_precommit_hook, uninstall_precommit_hook from installer

- Task 3 (Plan 8.7-03): Update verification scripts
  - scripts/verify_phase_07.py: add sub-test for new-file secret detection
  - scripts/verify_phase_71.py: update to expect 5 hooks (not 4)

</remaining_work>

<decisions_made>

- Fix is a 1-line change in hooks.py: `deleted_file` → `new_file`
  Rationale: GitPython's repo.index.diff("HEAD") treats new-to-repo files as
  deleted_file=True (they "disappear" going index→HEAD). Files actually deleted
  from the index appear as new_file=True. The existing code has the logic inverted.
  The FileNotFoundError catch at line 78 already handles genuine deletions.

- pre-commit hook fix: call install_precommit_hook(git_dir) in install_command()
  Same pattern as install_postcheckout_hook() and install_postrewrite_hook() (added in 7.1).
  installer.py already has install_precommit_hook(repo_path, force) — just not wired.

- 3 separate plans (not 1) to keep atomic commits and clear verification per fix.

- Phase 8.5 ROADMAP fix: both SUMMARY files existed (complete 2026-02-24), checkboxes
  were just never updated. Fixed in f728ade.

</decisions_made>

<blockers>

None. Both fixes are small, well-understood, and isolated.

</blockers>

<context>
These are real security gaps: a developer adding a new config.py with a hardcoded AWS key
would bypass the pre-commit secret scanner entirely (bug 1). And even if they wanted the
pre-commit hook, they'd have to install it manually since hooks install doesn't deploy it (bug 2).

The skipped test in verify_phase_71.py is test 4 (graphiti index --verbose) which requires
Ollama. Run without --skip-ollama to exercise it: `python scripts/verify_phase_71.py`
</context>

<next_action>
/clear then /gsd:execute-phase 8.7

Plans are in .planning/phases/8.7-gap-closure-hook-security-gaps-inserted/
All 3 plans are well-scoped (~1 file each for 01 and 02, minor script updates for 03).
</next_action>
