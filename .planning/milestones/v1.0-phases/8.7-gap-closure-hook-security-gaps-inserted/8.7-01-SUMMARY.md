---
phase: 8.7-gap-closure-hook-security-gaps-inserted
plan: "01"
subsystem: security
tags: [gitpython, hooks, secret-scanning, pre-commit, security]

# Dependency graph
requires:
  - phase: 07-git-integration
    provides: scan_staged_secrets() function in src/gitops/hooks.py
  - phase: 7.1-git-pivot
    provides: broader staged file scanning scope (not just journal/)
provides:
  - scan_staged_secrets() correctly detects secrets in newly staged files (brand-new files not yet in HEAD)
  - Initial-commit path fixed: repo.index.entries used instead of broken git.NULL_TREE fallback
affects:
  - phase: 8.7-02 (pre-commit hook wiring)
  - any future phase using scan_staged_secrets()

# Tech tracking
tech-stack:
  added: []
  patterns:
    - GitPython diff semantics: repo.index.diff("HEAD") marks new files as deleted_file=True and staged deletions as new_file=True (inverted from intuition)
    - Initial-commit path: iterate repo.index.entries when BadName raised (no HEAD); git.NULL_TREE unsupported in GitPython 3.x

key-files:
  created: []
  modified:
    - src/gitops/hooks.py

key-decisions:
  - "Skip when new_file=True (not deleted_file=True) to avoid skipping newly staged files — GitPython marks index-only files as deleted_file when diffing index->HEAD"
  - "Initial-commit fallback uses repo.index.entries directly — git.NULL_TREE is not supported by repo.index.diff() in GitPython 3.1.x"

patterns-established:
  - "Gather staged file paths into a list before scanning, unifying the HEAD-exists and initial-commit code paths"

requirements-completed: []

# Metrics
duration: 2min
completed: 2026-02-27
---

# Phase 8.7 Plan 01: Fix scan_staged_secrets Inverted deleted_file Check Summary

**scan_staged_secrets() now detects secrets in newly staged brand-new files by fixing inverted GitPython diff semantics (deleted_file/new_file swap) and rewriting the broken git.NULL_TREE initial-commit fallback to use repo.index.entries**

## Performance

- **Duration:** ~2 min
- **Started:** 2026-02-27T16:25:11Z
- **Completed:** 2026-02-27T16:27:21Z
- **Tasks:** 4 (read + apply fix + update comment + pytest)
- **Files modified:** 1

## Accomplishments

- Fixed inverted `deleted_file` vs `new_file` guard: newly staged files (deleted_file=True in GitPython's index->HEAD diff) are now scanned instead of skipped
- Fixed broken initial-commit fallback: replaced unsupported `repo.index.diff(git.NULL_TREE)` with direct `repo.index.entries` iteration
- Verified both cases: initial commit (no HEAD) and normal commit (with HEAD) correctly detect secrets in new staged files
- Verified staged deletions do NOT trigger false positives
- All 197 existing tests continue to pass

## Task Commits

Each task was committed atomically:

1. **Tasks 1-4: Read + apply fix + update comment + pytest** - `06d6260` (fix)

## Files Created/Modified

- `src/gitops/hooks.py` — Fixed `deleted_file` -> `new_file` guard in scan loop; rewrote initial-commit path to use `repo.index.entries` instead of broken `git.NULL_TREE` fallback; refactored to collect `staged_paths: list[str]` before scanning to unify both code paths

## Decisions Made

- Collect staged file paths into `staged_paths: list[str]` before the scan loop — unifies the HEAD-exists path (from `repo.index.diff("HEAD")`) and the no-HEAD path (from `repo.index.entries`) into a single scan loop.
- Use `repo.index.entries.keys()` to get `(path, stage_num)` tuples; take `entry_key[0]` to extract just the file path.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed broken initial-commit fallback (git.NULL_TREE unsupported in GitPython 3.x)**
- **Found during:** Task 4 verification (plan verification script)
- **Issue:** `repo.index.diff(git.NULL_TREE)` raises "other must be None, Diffable.INDEX, a Tree or Commit" in GitPython 3.1.46. The initial-commit path silently swallowed the error and returned empty warnings.
- **Fix:** Replaced `repo.index.diff(git.NULL_TREE)` with direct `repo.index.entries` iteration — yields `(path, stage_num)` tuples; take `[0]` for file path.
- **Files modified:** `src/gitops/hooks.py`
- **Verification:** Plan's verification script now outputs `PASS: new staged file detected`
- **Committed in:** `06d6260` (included in task commit)

---

**Total deviations:** 1 auto-fixed (Rule 1 - Bug)
**Impact on plan:** Auto-fix was required for the plan's own verification script to pass. No scope creep — stays within the single function and one file.

## Issues Encountered

None beyond the auto-fixed deviation above.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- `scan_staged_secrets()` is now correct for all cases: new staged files (with or without HEAD), modified files, and staged deletions
- Ready for Phase 8.7-02: wire `scan_staged_secrets()` into the pre-commit hook script deployed to `.git/hooks/pre-commit`

## Self-Check: PASSED

- FOUND: `src/gitops/hooks.py` (modified)
- FOUND: `.planning/phases/8.7-gap-closure-hook-security-gaps-inserted/8.7-01-SUMMARY.md` (this file)
- FOUND: commit `06d6260` (fix(hooks): scan_staged_secrets now catches secrets in new staged files)
- Note: `.planning/` is gitignored in this project — no separate docs commit is possible

---
*Phase: 8.7-gap-closure-hook-security-gaps-inserted*
*Completed: 2026-02-27*
