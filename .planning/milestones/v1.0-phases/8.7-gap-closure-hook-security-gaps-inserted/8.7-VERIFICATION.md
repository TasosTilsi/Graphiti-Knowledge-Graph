---
phase: 8.7-gap-closure-hook-security-gaps-inserted
verified: 2026-02-27T19:00:00Z
status: passed
score: 3/3 must-haves verified
re_verification: false
---

# Phase 8.7: Hook Security Gaps — Verification Report

**Phase Goal:** Close the two hook security gaps found during Phase 07/7.1 verification: (1) scan_staged_secrets silently skipping newly staged files, (2) pre-commit hook not deployed by graphiti hooks install.
**Verified:** 2026-02-27T19:00:00Z
**Status:** passed
**Re-verification:** No — initial verification

---

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | `scan_staged_secrets()` scans newly staged files (not yet in HEAD) | VERIFIED | `src/gitops/hooks.py` line 62 uses `if diff_item.new_file: continue` — correctly skips staged deletions, scans new files. Initial-commit path uses `repo.index.entries` (not broken `git.NULL_TREE`). Commit `06d6260`. |
| 2 | `graphiti hooks install` deploys all 5 hooks including pre-commit | VERIFIED | `src/cli/commands/hooks.py` calls `install_precommit_hook(root, force=force)`. `.git/hooks/pre-commit` exists, is executable (`-rwxr-xr-x`), contains exactly 1 `GRAPHITI_HOOK_START` marker. Commit `19ac3f2`. |
| 3 | Verification scripts assert fixed behaviour (not workaround) | VERIFIED | `scripts/verify_phase_07.py` Test 2 includes new-file sub-test (lines 212-220). `scripts/verify_phase_71.py` Test 2 checks 5 hooks including `pre-commit` (line 149). Commit `3da319a`. |

**Score:** 3/3 truths verified

---

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `src/gitops/hooks.py` | Fixed `deleted_file` guard in `scan_staged_secrets()` | VERIFIED | Line 62: `if diff_item.new_file: continue`. Lines 65-69: initial-commit fallback via `repo.index.entries.keys()`. Both code paths feed a unified `staged_paths` list. |
| `src/cli/commands/hooks.py` | Imports and calls `install_precommit_hook`, `uninstall_precommit_hook`, `is_precommit_hook_installed` | VERIFIED | Lines 21-23: imports present. Line 91: `install_precommit_hook(root, force=force)`. Line 200: `uninstall_precommit_hook(root)`. Line 265: `is_precommit_hook_installed(root)`. Line 296: "Git pre-commit" row in status table. |
| `scripts/verify_phase_07.py` | Sub-test for brand-new staged file detection | VERIFIED | Lines 212-220: creates `new_secrets.py`, stages it, calls `scan_staged_secrets()`, asserts warnings non-empty. Limitation comment removed. |
| `scripts/verify_phase_71.py` | `auto_installed_hooks` includes `pre-commit` (5 total) | VERIFIED | Line 149: `["pre-commit", "post-commit", "post-merge", "post-checkout", "post-rewrite"]`. Pre-commit special-case block removed. |
| `.git/hooks/pre-commit` | Deployed, executable, graphiti-managed | VERIFIED | `-rwxr-xr-x`, 919 bytes, 1 `GRAPHITI_HOOK_START` marker, shebang `#!/bin/sh`. |

---

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `scan_staged_secrets()` | newly staged files (no HEAD) | `repo.index.entries.keys()` fallback in `BadName` handler | WIRED | Lines 65-69 in `src/gitops/hooks.py`: `except git.exc.BadName` block iterates `repo.index.entries.keys()` and extracts `entry_key[0]` (file path). |
| `scan_staged_secrets()` | modified staged files | `repo.index.diff("HEAD")` with `new_file` guard | WIRED | Lines 58-64: `staged_diffs = repo.index.diff("HEAD")`, skips `diff_item.new_file`, appends `diff_item.a_path`. Both paths merge into `staged_paths` list. |
| `install_command()` | `install_precommit_hook()` | direct call with `root` and `force` | WIRED | Line 91: `precommit_installed = install_precommit_hook(root, force=force)`. Result reported in install output (line 118-121) and JSON (line 99). |
| `uninstall_command()` | `uninstall_precommit_hook()` | direct call with `root` | WIRED | Line 200: `precommit_removed = uninstall_precommit_hook(root)`. Result reported (line 218-219) and JSON (line 206). |
| `status_command()` | `is_precommit_hook_installed()` | direct call with `root`, renders table row | WIRED | Line 265: `precommit_installed = is_precommit_hook_installed(root)`. Line 295-298: `table.add_row("Git pre-commit", status_icon(precommit_installed))` — first row in table. |

---

### Requirements Coverage

| Requirement | Source Plans | Description | Status | Evidence |
|-------------|-------------|-------------|--------|----------|
| R8.1: Git-Safe Knowledge Graphs | 8.7-01, 8.7-02, 8.7-03 | No secrets in committed graphs (validation); CI rejects PRs with secrets | SATISFIED | `scan_staged_secrets()` now correctly scans all newly staged files. Pre-commit hook deployed via `graphiti hooks install`, executable at `.git/hooks/pre-commit`. Secret detection pipeline is complete and gated at commit time. |

---

### Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| `src/gitops/hooks.py` | 44 | `return []` (early return when GRAPHITI_SKIP=1) | Info | Intentional bypass — documented behaviour, tested in Test 3 of verify_phase_07.py |

No blockers or warnings. The single `return []` is a legitimate bypass guard, not a stub.

---

### Human Verification Required

#### 1. Runtime pre-commit hook execution

**Test:** In the project repo, run `git add <clean-file>` and then `git commit -m "test"`. Observe that the pre-commit hook runs silently with exit 0.
**Expected:** Commit succeeds; no error output from hook.
**Why human:** Requires an actual git commit in the live repository. The automated verify_phase_71.py Test 5 covers this, but it was run during plan execution (not during this verification session).

#### 2. Secret detection via pre-commit hook

**Test:** Stage a file containing a fake AWS key (`AKIAIOSFODNN7EXAMPLE`), attempt `git commit`. Observe hook output warning.
**Expected:** Pre-commit hook prints a warning about detected secrets. Commit may proceed (advisory) or be blocked depending on hook mode.
**Why human:** Requires live git commit with staged secret content. The unit-level `scan_staged_secrets()` is verified programmatically, but end-to-end hook execution requires a human operator.

---

### Gaps Summary

No gaps. All three observable truths are fully verified against the codebase:

1. The `scan_staged_secrets()` fix is substantive and correctly implemented — the inverted `deleted_file`/`new_file` check is reversed (line 62), and the initial-commit fallback is rewritten to use `repo.index.entries` (lines 65-69). Both code paths produce a `staged_paths` list that feeds the unified scan loop.

2. The pre-commit hook wiring is complete across all three CLI commands — install calls `install_precommit_hook(root, force=force)`, uninstall calls `uninstall_precommit_hook(root)`, and status calls `is_precommit_hook_installed(root)` and renders a "Git pre-commit" row first in the table. The hook file itself is installed, executable, and graphiti-managed.

3. The verification scripts are updated to directly test the fixed behaviour rather than working around it — `verify_phase_07.py` has the new-file sub-test and `verify_phase_71.py` expects all 5 hooks.

All three commits (`06d6260`, `19ac3f2`, `3da319a`) exist in git history and match the claimed changes.

---

_Verified: 2026-02-27T19:00:00Z_
_Verifier: Claude (gsd-verifier)_
