---
phase: 01-storage-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - tests/__init__.py
  - tests/test_storage.py
  - src/storage/graph_manager.py
autonomous: false

must_haves:
  truths:
    - "Data written to global graph persists after GraphManager close and reopen"
    - "Data written to project graph persists after GraphManager close and reopen"
    - "Global and project graphs are isolated (writing to one does not affect other)"
    - "Both graphs can be queried simultaneously"
  artifacts:
    - path: "tests/test_storage.py"
      provides: "Persistence and isolation verification tests"
      contains: "def test_"
  key_links:
    - from: "src/storage/graph_manager.py"
      to: "KuzuDriver"
      via: "execute() for persistence verification"
      pattern: "execute\\("
---

<objective>
Verify that the storage layer correctly persists data across restarts and maintains isolation between global and project graphs.

Purpose: Ensure the core promise of Phase 1 - persistent, dual-scope storage - actually works as expected.
Output: Passing tests that verify persistence and isolation, plus any fixes needed to make them pass.
</objective>

<execution_context>
@/home/tasostilsi/.claude/get-shit-done/workflows/execute-plan.md
@/home/tasostilsi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-storage-foundation/01-RESEARCH.md
@.planning/phases/01-storage-foundation/01-01-SUMMARY.md
@.planning/phases/01-storage-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create persistence verification tests</name>
  <files>
    tests/__init__.py
    tests/test_storage.py
  </files>
  <action>
Create tests/ directory and test file:

Create tests/__init__.py (empty file).

Create tests/test_storage.py with comprehensive persistence and isolation tests:
```python
"""
Persistence and isolation tests for dual-scope Kuzu storage.

These tests verify Phase 1 success criteria:
1. Data persists across GraphManager close/reopen
2. Global and project graphs are isolated
3. Both graphs can be accessed simultaneously
"""
import tempfile
import shutil
from pathlib import Path
import pytest
from src.storage import GraphSelector, GraphManager
from src.models import GraphScope
from src.config import GLOBAL_DB_PATH


class TestGraphSelector:
    """Tests for GraphSelector scope routing."""

    def test_find_project_root_in_git_repo(self, tmp_path):
        """Should find .git directory when present."""
        # Create fake git repo
        (tmp_path / ".git").mkdir()
        subdir = tmp_path / "src" / "nested"
        subdir.mkdir(parents=True)

        # Should find root from nested directory
        root = GraphSelector.find_project_root(subdir)
        assert root == tmp_path

    def test_find_project_root_not_in_git_repo(self, tmp_path):
        """Should return None when .git not found."""
        root = GraphSelector.find_project_root(tmp_path)
        assert root is None

    def test_determine_scope_preference_always_global(self, tmp_path):
        """Preferences should always use global scope."""
        (tmp_path / ".git").mkdir()

        scope, path = GraphSelector.determine_scope(
            operation_type="preference",
            start_path=tmp_path
        )

        assert scope == GraphScope.GLOBAL
        assert path is None

    def test_determine_scope_project_when_available(self, tmp_path):
        """Should use project scope when in git repo."""
        (tmp_path / ".git").mkdir()

        scope, path = GraphSelector.determine_scope(start_path=tmp_path)

        assert scope == GraphScope.PROJECT
        assert path == tmp_path

    def test_determine_scope_fallback_to_global(self, tmp_path):
        """Should fall back to global when not in git repo."""
        scope, path = GraphSelector.determine_scope(start_path=tmp_path)

        assert scope == GraphScope.GLOBAL
        assert path is None


class TestGraphManagerGlobal:
    """Tests for global scope database management."""

    def test_global_driver_creation(self):
        """Should create global driver at correct path."""
        manager = GraphManager()
        try:
            driver = manager.get_driver(GraphScope.GLOBAL)
            assert driver is not None
            assert GLOBAL_DB_PATH.parent.exists()
        finally:
            manager.close_all()

    def test_global_driver_singleton(self):
        """Should return same driver instance on repeated calls."""
        manager = GraphManager()
        try:
            driver1 = manager.get_driver(GraphScope.GLOBAL)
            driver2 = manager.get_driver(GraphScope.GLOBAL)
            assert driver1 is driver2
        finally:
            manager.close_all()


class TestGraphManagerProject:
    """Tests for project scope database management."""

    def test_project_driver_creation(self, tmp_path):
        """Should create project driver at correct path."""
        (tmp_path / ".git").mkdir()
        manager = GraphManager()
        try:
            driver = manager.get_driver(GraphScope.PROJECT, tmp_path)
            assert driver is not None
            assert (tmp_path / ".graphiti").exists()
        finally:
            manager.close_all()

    def test_project_driver_requires_path(self):
        """Should raise ValueError when project_root not provided."""
        manager = GraphManager()
        try:
            with pytest.raises(ValueError, match="project_root is required"):
                manager.get_driver(GraphScope.PROJECT, None)
        finally:
            manager.close_all()

    def test_project_switching(self, tmp_path):
        """Should handle switching between different projects."""
        project1 = tmp_path / "project1"
        project2 = tmp_path / "project2"
        (project1 / ".git").mkdir(parents=True)
        (project2 / ".git").mkdir(parents=True)

        manager = GraphManager()
        try:
            driver1 = manager.get_driver(GraphScope.PROJECT, project1)
            driver2 = manager.get_driver(GraphScope.PROJECT, project2)

            # Should be different drivers
            assert driver1 is not driver2
            # Both project directories should exist
            assert (project1 / ".graphiti").exists()
            assert (project2 / ".graphiti").exists()
        finally:
            manager.close_all()


class TestPersistence:
    """Tests verifying data persists across manager restarts.

    CRITICAL: These tests verify the core Phase 1 requirement that
    data survives application restarts.
    """

    @pytest.fixture
    def isolated_global_path(self, tmp_path, monkeypatch):
        """Use isolated global path for tests to avoid polluting user's real global DB."""
        test_global = tmp_path / "test_global" / "graphiti.kuzu"
        monkeypatch.setattr("src.config.paths.GLOBAL_DB_PATH", test_global)
        monkeypatch.setattr("src.storage.graph_manager.GLOBAL_DB_PATH", test_global)
        return test_global

    def test_global_persistence(self, isolated_global_path):
        """Data in global scope should survive manager restart."""
        # First session: write data
        manager1 = GraphManager()
        driver1 = manager1.get_driver(GraphScope.GLOBAL)

        # Use raw Kuzu connection to create a test node
        # (Graphiti's KuzuDriver provides .db attribute for raw access)
        conn = driver1.db.connect()
        try:
            # Create a simple test table and insert data
            conn.execute("CREATE NODE TABLE IF NOT EXISTS TestNode(id STRING PRIMARY KEY, value STRING)")
            conn.execute("CREATE (:TestNode {id: 'test1', value: 'persisted'})")
        finally:
            conn.close()

        manager1.close_all()

        # Second session: read data back
        manager2 = GraphManager()
        driver2 = manager2.get_driver(GraphScope.GLOBAL)

        conn = driver2.db.connect()
        try:
            result = conn.execute("MATCH (n:TestNode {id: 'test1'}) RETURN n.value AS value")
            rows = list(result)
            assert len(rows) == 1
            assert rows[0]['value'] == 'persisted'
        finally:
            conn.close()
            manager2.close_all()

    def test_project_persistence(self, tmp_path):
        """Data in project scope should survive manager restart."""
        (tmp_path / ".git").mkdir()

        # First session: write data
        manager1 = GraphManager()
        driver1 = manager1.get_driver(GraphScope.PROJECT, tmp_path)

        conn = driver1.db.connect()
        try:
            conn.execute("CREATE NODE TABLE IF NOT EXISTS TestNode(id STRING PRIMARY KEY, value STRING)")
            conn.execute("CREATE (:TestNode {id: 'proj1', value: 'project_data'})")
        finally:
            conn.close()

        manager1.close_all()

        # Second session: read data back
        manager2 = GraphManager()
        driver2 = manager2.get_driver(GraphScope.PROJECT, tmp_path)

        conn = driver2.db.connect()
        try:
            result = conn.execute("MATCH (n:TestNode {id: 'proj1'}) RETURN n.value AS value")
            rows = list(result)
            assert len(rows) == 1
            assert rows[0]['value'] == 'project_data'
        finally:
            conn.close()
            manager2.close_all()


class TestIsolation:
    """Tests verifying global and project graphs are isolated."""

    @pytest.fixture
    def isolated_global_path(self, tmp_path, monkeypatch):
        """Use isolated global path for tests."""
        test_global = tmp_path / "test_global" / "graphiti.kuzu"
        monkeypatch.setattr("src.config.paths.GLOBAL_DB_PATH", test_global)
        monkeypatch.setattr("src.storage.graph_manager.GLOBAL_DB_PATH", test_global)
        return test_global

    def test_global_and_project_isolation(self, isolated_global_path, tmp_path):
        """Writing to global should not affect project and vice versa."""
        project_root = tmp_path / "project"
        (project_root / ".git").mkdir(parents=True)

        manager = GraphManager()
        try:
            # Get both drivers
            global_driver = manager.get_driver(GraphScope.GLOBAL)
            project_driver = manager.get_driver(GraphScope.PROJECT, project_root)

            # Write different data to each
            global_conn = global_driver.db.connect()
            project_conn = project_driver.db.connect()

            try:
                # Global: create table and insert
                global_conn.execute("CREATE NODE TABLE IF NOT EXISTS IsolationTest(id STRING PRIMARY KEY, scope STRING)")
                global_conn.execute("CREATE (:IsolationTest {id: 'iso1', scope: 'global'})")

                # Project: create same table structure but different data
                project_conn.execute("CREATE NODE TABLE IF NOT EXISTS IsolationTest(id STRING PRIMARY KEY, scope STRING)")
                project_conn.execute("CREATE (:IsolationTest {id: 'iso1', scope: 'project'})")

                # Verify global only sees global data
                global_result = global_conn.execute("MATCH (n:IsolationTest) RETURN n.scope AS scope")
                global_rows = list(global_result)
                assert len(global_rows) == 1
                assert global_rows[0]['scope'] == 'global'

                # Verify project only sees project data
                project_result = project_conn.execute("MATCH (n:IsolationTest) RETURN n.scope AS scope")
                project_rows = list(project_result)
                assert len(project_rows) == 1
                assert project_rows[0]['scope'] == 'project'

            finally:
                global_conn.close()
                project_conn.close()

        finally:
            manager.close_all()

    def test_simultaneous_access(self, isolated_global_path, tmp_path):
        """Both graphs should be accessible simultaneously."""
        project_root = tmp_path / "project"
        (project_root / ".git").mkdir(parents=True)

        manager = GraphManager()
        try:
            global_driver = manager.get_driver(GraphScope.GLOBAL)
            project_driver = manager.get_driver(GraphScope.PROJECT, project_root)

            # Both drivers should exist and be different
            assert global_driver is not project_driver
            assert global_driver is not None
            assert project_driver is not None

            # Both should be usable
            global_conn = global_driver.db.connect()
            project_conn = project_driver.db.connect()

            try:
                # Both can execute queries
                global_result = global_conn.execute("RETURN 'global' AS source")
                project_result = project_conn.execute("RETURN 'project' AS source")

                assert list(global_result)[0]['source'] == 'global'
                assert list(project_result)[0]['source'] == 'project'
            finally:
                global_conn.close()
                project_conn.close()

        finally:
            manager.close_all()
```

Add pytest to pyproject.toml dev dependencies. Update pyproject.toml to include:
```toml
[project.optional-dependencies]
dev = [
    "pytest>=8.0.0",
]
```
  </action>
  <verify>
Install dev dependencies and run tests:
```bash
cd /home/tasostilsi/Development/Projects/graphiti-knowledge-graph
pip install -e ".[dev]"
pytest tests/test_storage.py -v
```

All tests should pass. If any fail, the next task will address fixes.
  </verify>
  <done>
Test suite exists covering:
- GraphSelector project detection and scope routing
- GraphManager driver creation and singleton behavior
- Persistence across manager restarts (both scopes)
- Isolation between global and project graphs
- Simultaneous access to both graphs
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix any failing tests</name>
  <files>
    src/storage/graph_manager.py
  </files>
  <action>
Run the tests from Task 1. If any tests fail:

1. Analyze the failure output to understand the root cause
2. Fix the issue in the appropriate source file (most likely graph_manager.py)
3. Re-run tests to confirm fix

Common issues that might surface:
- KuzuDriver.db might not be the attribute name (check Graphiti source)
- Connection API might differ from expected
- Path creation timing issues

If KuzuDriver doesn't expose raw Kuzu database, we may need to:
- Access via KuzuDriver._db or similar internal attribute
- Or create our own kuzu.Database wrapper alongside KuzuDriver

Document any deviations from RESEARCH.md assumptions.
  </action>
  <verify>
```bash
pytest tests/test_storage.py -v
```
All tests pass.
  </verify>
  <done>
All persistence and isolation tests pass, confirming Phase 1 success criteria are met.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete storage foundation with:
- GraphSelector for scope routing (detects project root via .git)
- GraphManager for dual-scope Kuzu database management
- Persistence verified via tests (data survives restarts)
- Isolation verified via tests (global and project don't interfere)
  </what-built>
  <how-to-verify>
1. Run the full test suite:
   ```bash
   cd /home/tasostilsi/Development/Projects/graphiti-knowledge-graph
   pytest tests/test_storage.py -v
   ```
   All tests should pass.

2. Verify global database was created:
   ```bash
   ls -la ~/.graphiti/global/
   ```
   Should show graphiti.kuzu directory.

3. Quick manual persistence check:
   ```bash
   python -c "
   from src.storage import GraphManager
   from src.models import GraphScope

   # Write
   m = GraphManager()
   d = m.get_driver(GraphScope.GLOBAL)
   c = d.db.connect()
   c.execute('CREATE NODE TABLE IF NOT EXISTS ManualTest(id STRING PRIMARY KEY)')
   c.execute(\"CREATE (:ManualTest {id: 'manual1'})\")
   c.close()
   m.close_all()
   print('Data written')

   # Read in new session
   m2 = GraphManager()
   d2 = m2.get_driver(GraphScope.GLOBAL)
   c2 = d2.db.connect()
   result = c2.execute('MATCH (n:ManualTest) RETURN count(n) AS cnt')
   print(f'Count after restart: {list(result)[0][\"cnt\"]}')
   c2.close()
   m2.close_all()
   "
   ```
   Should print count > 0, proving persistence.

4. Confirm project scope works (from this git repo):
   ```bash
   cd /home/tasostilsi/Development/Projects/graphiti-knowledge-graph
   python -c "
   from src.storage import GraphSelector, GraphManager
   from src.models import GraphScope

   scope, root = GraphSelector.determine_scope()
   print(f'Scope: {scope}, Root: {root}')

   m = GraphManager()
   d = m.get_driver(scope, root)
   print(f'Driver created: {type(d).__name__}')
   m.close_all()
   "
   ```
   Should show PROJECT scope and the project root path.
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
Phase 1 success criteria verification:
1. Kuzu database initializes for global scope - verified by TestGraphManagerGlobal
2. Kuzu database initializes for project scope - verified by TestGraphManagerProject
3. Data persists across restarts - verified by TestPersistence
4. Correct scope selection based on context - verified by TestGraphSelector
5. Both graphs accessible simultaneously - verified by TestIsolation.test_simultaneous_access
</verification>

<success_criteria>
- All pytest tests pass
- Global database created at ~/.graphiti/global/graphiti.kuzu
- Project database created at {project}/.graphiti/graphiti.kuzu when used
- Data written survives manager close/reopen
- Global and project data are isolated
- Human verification confirms system works as expected
</success_criteria>

<output>
After completion, create `.planning/phases/01-storage-foundation/01-03-SUMMARY.md`
</output>
