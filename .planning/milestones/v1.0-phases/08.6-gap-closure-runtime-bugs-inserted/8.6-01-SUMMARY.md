---
phase: 8.6-gap-closure-runtime-bugs-inserted
plan: "01"
subsystem: llm-integration
tags: [pydantic, json-normalization, ollama, cloud-llm, adapters, field-validation]

# Dependency graph
requires:
  - phase: 03-llm-integration
    provides: OllamaLLMClient adapter with _generate_response() and structured output parsing
  - phase: 06-automatic-capture
    provides: process_pending_commits() that calls graphiti entity extraction via OllamaLLMClient
provides:
  - _normalize_field_names() static method on OllamaLLMClient that strips leading dots from JSON keys
  - Dot-prefixed filename robustness in LLM JSON output parsing
affects: [phase-06-automatic-capture, phase-08-mcp-server, phase-09-advanced-features]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Defensive JSON normalization before Pydantic validation to handle cloud model quirks"
    - "Recursive dict/list traversal for key normalization"

key-files:
  created: []
  modified:
    - src/graph/adapters.py

key-decisions:
  - "Strip leading dots from all dict keys recursively before any model_validate() call, not just at the top level — nested entities in extracted_entities list also need normalization"
  - "Place normalization after JSON parse, before both the bare-list fallback and the normal dict model_validate — one call site covers all paths"
  - "Use str.lstrip('.') not str.lstrip('.').strip() — strip only leading dots, never trailing"

patterns-established:
  - "JSON normalization helper: placed alongside _strip_schema_suffix and _inject_example as a @staticmethod on OllamaLLMClient"

requirements-completed:
  - R4.1
  - R4.2

# Metrics
duration: 2min
completed: 2026-02-27
---

# Phase 8.6 Plan 01: Dot-prefixed LLM field name normalization in OllamaLLMClient Summary

**Added `_normalize_field_names()` to `OllamaLLMClient` that recursively strips leading dots from JSON keys before Pydantic validation, fixing `Field required` ValidationError when cloud models produce `{".name": ".env.test_verification"}` instead of `{"name": ".env.test_verification"}`.**

## Performance

- **Duration:** ~2 min
- **Started:** 2026-02-27T07:03:34Z
- **Completed:** 2026-02-27T07:05:44Z
- **Tasks:** 2 (Task 1: implementation; Task 2: smoke test)
- **Files modified:** 1

## Accomplishments

- Added `OllamaLLMClient._normalize_field_names(data)` static method that recursively fixes dot-prefixed keys in any dict/list structure returned by LLM JSON parsing
- Called `self._normalize_field_names(parsed_data)` in `_generate_response()` as a single normalization point before all `model_validate()` paths (covers both normal dict path and bare-list fallback)
- Smoke test verified: exact payload `{".name": ".env.test_verification", "entity_type_id": 0}` normalizes to `{"name": ".env.test_verification", "entity_type_id": 0}` with value preserved

## Task Commits

Each task was committed atomically:

1. **Task 1: Add _normalize_field_names() and call before Pydantic validation** - `7f55287` (fix)

**Plan metadata:** (to be added by final commit)

_Note: Task 2 was a verification-only smoke test; no code changes, included in Task 1 commit._

## Files Created/Modified

- `src/graph/adapters.py` - Added `_normalize_field_names()` static method and called it before all `model_validate()` calls in `_generate_response()`

## Decisions Made

- Single normalization call site at line 249 of `_generate_response()`, after `json.loads()` and before the `isinstance(parsed_data, list)` check — this covers both the bare-list fallback branch and the normal dict branch with one call
- `lstrip(".")` used over `strip(".")` — only leading dots are the problem (dot-prefixed filenames), trailing dots in values must be preserved

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Phase 8.6 Plan 02 (queue race condition fix) is the next plan in this gap-closure phase
- After both 8.6 plans complete, Phase 06 human verification Tests 3 and 4 can be re-run
- `process_pending_commits()` will no longer drop entire entity batches due to one dot-prefixed filename in the commit diff

---
*Phase: 8.6-gap-closure-runtime-bugs-inserted*
*Completed: 2026-02-27*

## Self-Check: PASSED

- FOUND: src/graph/adapters.py
- FOUND: .planning/phases/08.6-gap-closure-runtime-bugs-inserted/8.6-01-SUMMARY.md
- FOUND commit: 7f55287 (fix(8.6-01): add _normalize_field_names() and call before Pydantic validation)
